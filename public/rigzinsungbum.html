<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰æ—ºè«¾å¸ƒæ–‡é›†é–±è¦½é¤¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Tibetan:wght@300;400;500;600;700&family=Noto+Serif+TC:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(20, 20, 30, 0.65);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text-light: rgba(240, 240, 255, 0.95);
            --text-accent: #FFD700;
            --text-like: #e74c3c;
            --tibetan-title-font: 'Noto Sans Tibetan', serif;
            --chinese-title-font: 'Noto Serif TC', serif;
            --english-font: 'Inter', sans-serif;
            --chinese-content-font: 'Noto Serif TC', serif;
            --border-radius-main: 10px;
            --border-radius-small: 5px;
        }

        body {
            font-family: var(--english-font);
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
            min-height: 100vh;
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            padding-top: 60px;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><pattern id="books" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse"><rect width="20" height="80" x="10" y="10" fill="rgba(255,255,255,0.05)" rx="2"/><rect width="20" height="75" x="35" y="15" fill="rgba(255,255,255,0.03)" rx="2"/><rect width="20" height="70" x="60" y="20" fill="rgba(255,255,255,0.04)" rx="2"/></pattern></defs><rect width="100%" height="100%" fill="url(%23books)"/></svg>') repeat;
            opacity: 0.3;
            z-index: -1;
        }

        .top-nav {
            background: rgba(10, 10, 20, 0.9);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            height: 60px;
        }

        .nav-left { display: flex; gap: 15px; align-items: center; }
        .nav-right { display: flex; gap: 10px; align-items: center; }
        
        .nav-item, .top-nav-btn {
            color: var(--text-light); 
            text-decoration: none; 
            padding: 8px 15px;
            border-radius: var(--border-radius-small); 
            transition: all 0.3s ease;
            font-size: 14px; 
            background: transparent; 
            border: 1px solid transparent; 
            cursor: pointer;
            white-space: nowrap;
            user-select: none;
        }
        
        #toggleSidebarBtn { 
            font-size: 1.3rem; 
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
        }
        
        .nav-item:hover, .top-nav-btn:hover { 
            background: rgba(255, 255, 255, 0.15); 
            color: white;
            transform: translateY(-1px);
        }

        .nav-item:active, .top-nav-btn:active {
            transform: translateY(0);
        }

        #modeSelectorScreen { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            flex-grow: 1; 
            text-align: center; 
            position: relative; 
            z-index: 10; 
            padding: 2rem;
        }

        .mode-selector-content { 
            background: var(--glass-bg); 
            backdrop-filter: blur(15px); 
            border-radius: var(--border-radius-main); 
            padding: 3rem 2.5rem; 
            border: 1px solid var(--glass-border); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.3); 
            animation: fadeInUp 0.8s ease-out; 
            max-width: 800px; 
            width: 90%;
        }

        @keyframes fadeInUp { 
            from { opacity: 0; transform: translateY(30px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .main-title {
            font-family: var(--chinese-title-font); 
            font-size: 3.2rem; 
            font-weight: bold; 
            margin-bottom: 1rem; 
            letter-spacing: 2px; 
            background: linear-gradient(45deg, #fff, #e0e0ff, var(--text-accent)); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            background-clip: text;
        }

        .tibetan-subtitle {
            font-family: var(--tibetan-title-font); 
            font-size: 1.6rem; 
            color: var(--text-light); 
            margin-bottom: 1rem; 
            opacity: 0.9;
        }

        .english-subtitle { 
            font-size: 1.1rem; 
            color: var(--text-light); 
            margin-bottom: 2.5rem; 
            opacity: 0.8; 
            font-style: italic; 
            font-family: var(--english-font);
        }

        .mode-buttons { 
            display: flex; 
            gap: 1.5rem; 
            flex-wrap: wrap; 
            justify-content: center; 
            margin-bottom: 1.5rem; 
        }

        .mode-button { 
            padding: 1rem 2.5rem; 
            font-size: 1.1rem; 
            font-weight: 600; 
            border: none; 
            border-radius: 25px; 
            cursor: pointer; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            position: relative; 
            overflow: hidden; 
            background: rgba(255,255,255,0.15); 
            color: white; 
            border: 2px solid var(--glass-border); 
            backdrop-filter: blur(8px); 
            min-width: 180px;
            user-select: none;
        }

        .mode-button:hover { 
            transform: translateY(-8px) scale(1.05); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.3); 
            background: rgba(255,255,255,0.25);
            border-color: var(--text-accent);
        }

        .mode-button:active {
            transform: translateY(-4px) scale(1.02);
        }

        #appContainer { 
            display: none; 
            width: 100%; 
            flex-grow: 1; 
            opacity: 0; 
            animation: fadeIn 0.6s ease-out forwards; 
        }

        @keyframes fadeIn { to { opacity: 1; } }
        body.app-active #appContainer { display: flex; }

        .sidebar {
            width: 300px;
            background: var(--glass-bg); 
            backdrop-filter: blur(20px); 
            overflow-y: auto;
            position: fixed; 
            height: calc(100vh - 60px);
            left: 0; 
            top: 60px;
            z-index: 200;
            border-right: 1px solid var(--glass-border);
            transform: translateX(-100%);
            transition: transform 0.3s ease-out;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar-header { 
            padding: 2rem 1.5rem; 
            border-bottom: 1px solid var(--glass-border);
        }
        
        .sidebar-title { 
            font-family: var(--chinese-title-font); 
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
        }
        
        .sidebar-subtitle { 
            font-family: var(--tibetan-title-font); 
            opacity: 0.8;
            font-size: 1rem;
        }

        .main-content {
            flex: 1; 
            margin-left: 0;
            min-height: calc(100vh - 60px);
            position: relative; 
            transition: all 0.3s ease-out;
            padding: 2rem;
            z-index: 50;
        }

        .main-content.sidebar-active {
            margin-left: 300px;
        }

        .main-content.with-right-sidebar {
            margin-right: 300px; 
        }

        .main-content.sidebar-active.with-right-sidebar {
            margin-left: 300px;
            margin-right: 300px;
        }

        .utility-sidebar {
            width: 300px;
            background: var(--glass-bg); 
            backdrop-filter: blur(20px); 
            overflow-y: auto;
            position: fixed; 
            height: calc(100vh - 60px);
            right: 0; 
            top: 60px;
            z-index: 190;
            border-left: 1px solid var(--glass-border);
            transition: transform 0.3s ease-out;
            transform: translateX(100%);
        }

        .utility-sidebar.active {
            transform: translateX(0);
        }

        .utility-sidebar-header { 
            padding: 2rem 1.5rem; 
            position: relative; 
            border-bottom: 1px solid var(--glass-border); 
        }

        .utility-sidebar-title { 
            font-family: var(--chinese-title-font); 
            margin: 0; 
            color: var(--text-light);
            font-size: 1.4rem; 
        }

        .utility-sidebar-content { padding: 1.5rem; }

        .utility-item { 
            padding: 1rem; 
            margin: 0.5rem 0; 
            background: rgba(255, 255, 255, 0.08); 
            border-radius: var(--border-radius-small); 
            cursor: pointer; 
            transition: all 0.3s ease; 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            color: var(--text-light);
            user-select: none;
        }

        .utility-item:hover { 
            background: rgba(255, 255, 255, 0.2); 
            transform: translateX(8px);
        }

        .utility-item-icon { 
            font-size: 1.3rem; 
            width: 2rem; 
            text-align: center; 
        }

        .container { max-width: 1400px; margin: 0 auto; }

        .header { 
            text-align: center; 
            margin-bottom: 3rem; 
            color: white; 
        }

        .header h1 { 
            font-family: var(--chinese-title-font); 
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .header .tibetan-subtitle-header { 
            font-family: var(--tibetan-title-font); 
            font-size: 1.8rem; 
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .header p:not(.tibetan-subtitle-header) { 
            font-family: var(--english-font);
            font-size: 1.1rem;
            opacity: 0.8;
        }

        .search-section { 
            max-width: 700px; 
            margin: 0 auto 3rem; 
        }

        .search-container { 
            position: relative; 
            border-radius: var(--border-radius-small); 
        }

        .search-input { 
            width: 100%; 
            padding: 1rem 1.2rem 1rem 3.5rem; 
            font-size: 1.1rem; 
            background: rgba(255, 255, 255, 0.1); 
            border: 2px solid var(--glass-border); 
            border-radius: var(--border-radius-small); 
            color: var(--text-light); 
            font-family: var(--english-font);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--text-accent);
            background: rgba(255, 255, 255, 0.15);
        }

        .search-input::placeholder { 
            color: rgba(255, 255, 255, 0.6); 
        }

        .search-icon { 
            position: absolute; 
            left: 1.2rem; 
            top: 50%; 
            transform: translateY(-50%); 
            font-size: 1.2rem; 
            color: rgba(255, 255, 255, 0.6); 
        }

        .stats-bar { 
            background: var(--glass-bg); 
            backdrop-filter: blur(15px); 
            border: 1px solid var(--glass-border); 
            border-radius: var(--border-radius-main); 
            padding: 1.5rem 2rem; 
            margin-bottom: 2rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        .view-controls { display: flex; gap: 0.8rem; }

        .view-btn { 
            padding: 0.8rem 1.5rem; 
            font-size: 0.9rem; 
            border-radius: var(--border-radius-small); 
            border: 1px solid var(--glass-border); 
            background: transparent; 
            color: var(--text-light); 
            cursor: pointer; 
            transition: all 0.3s ease;
            user-select: none;
        }

        .view-btn:hover, .view-btn.active { 
            background: rgba(255, 255, 255, 0.2); 
            color: white;
            transform: translateY(-2px);
        }

        .documents-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem; 
            margin-bottom: 2rem;
        }

        .document-card {
            background: rgba(30,30,40,0.8);
            backdrop-filter: blur(15px);
            border-radius: var(--border-radius-main); 
            padding: 2rem;
            border: 1px solid var(--glass-border);
            transition: all 0.4s ease;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .document-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .document-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .document-card:hover::before {
            opacity: 1;
        }

        .document-title { 
            font-size: 1.4rem; 
            font-family: var(--tibetan-title-font);
            margin-bottom: 0.8rem;
            line-height: 1.4;
        }

        .document-subtitle { 
            font-size: 1.2rem; 
            font-family: var(--chinese-title-font);
            margin-bottom: 0.8rem;
            color: var(--text-accent);
            line-height: 1.4;
        }

        .document-meta { 
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 1.2rem;
            font-family: var(--english-font);
        }

        .document-preview { 
            font-size: 0.95rem; 
            padding: 1rem; 
            border-radius: var(--border-radius-small);
            background: rgba(0, 0, 0, 0.3);
            margin-bottom: 1.5rem;
            opacity: 0.9;
            line-height: 1.6;
            flex-grow: 1; 
            max-height: 120px; 
            overflow: hidden;
            font-family: var(--chinese-content-font);
        }

        .document-card-actions {
            display: flex;
            gap: 0.8rem;
            align-items: center;
            margin-top: auto; 
        }

        .like-btn {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.6rem;
            cursor: pointer;
            padding: 0.5rem;
            margin-left: auto;
            transition: all 0.3s ease;
            border-radius: 50%;
            user-select: none;
        }

        .like-btn:hover {
            transform: scale(1.2);
            background: rgba(255, 255, 255, 0.1);
        }

        .like-btn.liked {
            color: var(--text-like);
            animation: heartBeat 0.6s ease;
        }

        @keyframes heartBeat {
            0%, 50%, 100% { transform: scale(1); }
            25%, 75% { transform: scale(1.3); }
        }

        .btn { 
            padding: 0.8rem 1.8rem; 
            font-size: 0.95rem; 
            border-radius: var(--border-radius-small); 
            justify-content: center; 
            text-align: center; 
            border: 1px solid var(--glass-border); 
            background: rgba(255, 255, 255, 0.1); 
            color: var(--text-light); 
            cursor: pointer; 
            transition: all 0.3s ease; 
            text-decoration: none; 
            display: inline-flex; 
            align-items: center;
            user-select: none;
            font-weight: 500;
        }

        .btn:hover { 
            background: rgba(255, 255, 255, 0.2); 
            color: white;
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .admin-only { display: none !important; } 
        .reader-only { display: none !important; }
        body.edit-mode .admin-only { display: inline-flex !important; }
        body.read-mode .reader-only { display: block !important; }
        body.read-mode .top-nav-btn.reader-only { display: inline-flex !important; }
        body.read-mode .document-card-actions .reader-only { display: inline-flex !important; }

        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.8); 
            z-index: 2000; 
            justify-content: center; 
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal.active { 
            display: flex; 
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content { 
            background: var(--glass-bg); 
            backdrop-filter: blur(20px); 
            border: 1px solid var(--glass-border); 
            border-radius: var(--border-radius-main); 
            padding: 2.5rem; 
            max-width: 90vw; 
            max-height: 90vh; 
            overflow-y: auto; 
            position: relative; 
            display: flex; 
            flex-direction: column;
            animation: modalSlideIn 0.4s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-30px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        .modal-close { 
            position: absolute; 
            top: 1.5rem; 
            right: 1.5rem; 
            background: rgba(255, 255, 255, 0.1); 
            border: 1px solid var(--glass-border);
            color: var(--text-light); 
            font-size: 1.5rem; 
            cursor: pointer; 
            z-index: 10;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        /* Form styles */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 1rem;
            border-radius: var(--border-radius-small);
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            font-family: var(--english-font);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--text-accent);
            background: rgba(255, 255, 255, 0.15);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
            font-family: var(--chinese-content-font);
        }

        /* Loading states */
        .loading {
            pointer-events: none;
            opacity: 0.6;
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid var(--text-accent);
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Message area */
        #messageArea {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 3000;
            max-width: 400px;
        }

        .message {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius-small);
            margin-bottom: 0.5rem;
            border-left: 4px solid var(--text-accent);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            animation: slideInRight 0.4s ease-out;
        }

        .message.error {
            border-left-color: #e74c3c;
        }

        .message.success {
            border-left-color: #27ae60;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            body { padding-top: 60px; }
            
            .top-nav { 
                padding: 8px 15px;
                flex-wrap: wrap; 
            }
            
            .nav-left { 
                gap: 8px; 
                order: 1; 
                flex-grow: 1;
            }
            
            #toggleSidebarBtn { 
                order: -1; 
                margin-right: auto;
            }
            
            .nav-right { 
                order: 2; 
                flex-grow: 1; 
                justify-content: flex-end;
            }
            
            .nav-item, .top-nav-btn { 
                font-size: 13px; 
                padding: 6px 10px; 
            }

            .sidebar, .utility-sidebar { 
                width: 280px; 
            }
            
            .main-content.sidebar-active { 
                margin-left: 280px; 
            }
            
            .main-content.with-right-sidebar { 
                margin-right: 280px; 
            }

            .main-title { 
                font-size: 2.5rem; 
            }
            
            .mode-selector-content { 
                padding: 2rem 1.5rem; 
            }
            
            .documents-grid { 
                grid-template-columns: 1fr; 
                gap: 1.5rem;
            }
            
            .modal-content { 
                max-width: 95vw; 
                padding: 1.5rem; 
            }

            #messageArea {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="top-nav">
        <div class="nav-left" id="navLeftLinks">
            <button class="top-nav-btn" id="toggleSidebarBtn" onclick="toggleLeftSidebar()">â˜°</button>
            <a href="javascript:void(0)" class="nav-item" onclick="showModeSelectorScreen()">å›é¦–é </a>
            <a href="javascript:void(0)" class="nav-item" onclick="showInfo('é—œæ–¼æˆ‘å€‘')">é—œæ–¼æˆ‘å€‘</a>
            <a href="javascript:void(0)" class="nav-item" onclick="showInfo('ç·¨è€…çš„è©±')">ç·¨è€…çš„è©±</a>
            <a href="javascript:void(0)" class="nav-item" onclick="showInfo('åƒè€ƒè³‡æº')">åƒè€ƒè³‡æº</a>
        </div>
        <div class="nav-right" id="navRightControls">
            <!-- Content dynamically set by JS -->
        </div>
    </nav>

    <!-- Mode Selection Screen -->
    <div id="modeSelectorScreen">
        <div class="mode-selector-content">
            <h1 class="main-title">æ‰æ—ºè«¾å¸ƒæ–‡é›†é–±è¦½é¤¨</h1>
            <p class="tibetan-subtitle">à¼„à¼…à¼ à¼à½šà½ºà¼‹à½‘à½–à½„à¼‹à½“à½¼à½¢à¼‹à½–à½´à½ à½²à¼‹à½‚à½¦à½´à½„à¼‹à½ à½–à½´à½˜à¼‹à½€à¾³à½¼à½‚à¼‹à½¦à¾Ÿà½ºà½‚à½¦à¼</p>
            <p class="english-subtitle">Tsewang Norbu Collected Works</p>
            <div class="mode-buttons">
                <button class="mode-button" onclick="enterMode('read')">ğŸ“– é€²å…¥é–±è¦½</button>
            </div>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="appContainer">
        <!-- Left Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title">èª²ç¨‹ç›®éŒ„</h2>
                <p class="sidebar-subtitle">à½¦à¾³à½¼à½–à¼‹à½šà½“à¼‹à½‚à¾±à½²à¼‹à½‘à½€à½¢à¼‹à½†à½‚</p>
            </div>
            <nav class="course-menu" id="courseMenuContainer">
                <div style="padding: 1rem; color: var(--text-light); opacity: 0.8;">è¼‰å…¥ä¸­...</div>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content" id="mainContentArea">
            <div class="container">
                <header class="header">
                    <h1>æ‰æ—ºè«¾å¸ƒæ–‡é›†é–±è¦½é¤¨</h1>
                    <p class="tibetan-subtitle-header">à¼„à¼…à¼ à¼à½šà½ºà¼‹à½‘à½–à½„à¼‹à½“à½¼à½¢à¼‹à½–à½´à½ à½²à¼‹à½‚à½¦à½´à½„à¼‹à½ à½–à½´à½˜à¼‹à½€à¾³à½¼à½‚à¼‹à½¦à¾Ÿà½ºà½‚à½¦à¼</p>
                    <p>Tsewang Norbu Collected Works</p>
                </header>
                
                <div class="search-section">
                    <div class="search-container">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" class="search-input" placeholder="æœå°‹æ–‡ç»æ¨™é¡Œã€å…§å®¹æˆ–ä½œè€…..." id="searchInputEl">
                    </div>
                </div>
                
                <div class="stats-bar">
                    <div class="view-controls">
                        <button class="view-btn active" id="gridViewBtn">ğŸ“‡ å¡ç‰‡æª¢è¦–</button>
                        <button class="view-btn" id="listViewBtn">ğŸ“‹ æ¸…å–®æª¢è¦–</button>
                    </div>
                    <div style="font-size: 1rem; opacity: 0.9; font-weight: 500;">
                        ç¸½è¨ˆ <strong id="totalCountEl">0</strong> éƒ¨æ–‡ç»
                    </div>
                </div>
                
                <div class="documents-grid" id="documentsGridEl">
                    <!-- Documents will be rendered here -->
                </div>
            </div>
        </main>

        <!-- Right Utility Sidebar -->
        <aside class="utility-sidebar" id="utilitySidebarEl">
            <div class="utility-sidebar-header">
                <h3 class="utility-sidebar-title">å¯¦ç”¨å·¥å…·</h3>
                <button class="modal-close" onclick="toggleUtilitySidebar()">Ã—</button>
            </div>
            <div class="utility-sidebar-content">
                <div class="utility-item" onclick="showFavorites()">
                    <span class="utility-item-icon">â¤ï¸</span> å·²æ”¶è—æ–‡ç« 
                </div>
                <div id="favoritesListContainerEl" style="display:none; padding: 0.5rem 1rem;">
                    <!-- Favorite items will be listed here -->
                </div>
                <div class="utility-item" onclick="openReportErrorModal()">
                    <span class="utility-item-icon">ğŸ“§</span> å›å ±éŒ¯å­—
                </div>
                <div class="utility-item" onclick="showUtilityModal('donateModal', 'è­·æŒè´ŠåŠ©')">
                    <span class="utility-item-icon">ğŸ’°</span> è­·æŒè´ŠåŠ©
                </div>
                <div class="utility-item" onclick="contactSupport()">
                    <span class="utility-item-icon">ğŸ“</span> è¯ç¹«å®¢æœ
                </div>
            </div>
        </aside>
    </div>

    <!-- Document Modal -->
    <div class="modal" id="documentModal">
        <div class="modal-content" style="max-width: 900px;">
            <button class="modal-close" onclick="closeModal('documentModal')">Ã—</button>
            <div id="modalHeaderContent">
                <h2 class="modal-document-title-zh">è¼‰å…¥ä¸­...</h2>
                <p class="modal-document-title-bo"></p>
                <p class="modal-document-title-en"></p>
            </div>
            <div class="language-switcher-modal" id="languageSwitcherModal"></div>
            <div class="language-content-container">
                <div id="modalTibetanContentEl" class="language-content tibetan-text" style="display:none;"></div>
                <hr id="modalLanguageSeparator" style="display:none;">
                <div id="modalChineseContentEl" class="language-content chinese-text" style="display:none;"></div>
                <hr id="modalLanguageSeparator2" style="display:none;"> 
                <div id="modalEnglishContentEl" class="language-content english-text" style="display:none;"></div>
            </div>
            <div id="modalMetaContent"></div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div class="modal" id="adminLoginModal">
        <div class="modal-content" style="max-width: 450px;">
            <button class="modal-close" onclick="closeModal('adminLoginModal')">Ã—</button>
            <h2 style="margin-bottom: 2rem; text-align: center; font-family: var(--chinese-title-font);">ç®¡ç†å“¡ç™»å…¥</h2>
            <form id="adminLoginForm">
                <div class="form-group">
                    <label for="adminUsername">ç”¨æˆ¶åï¼š</label>
                    <input type="text" id="adminUsername" required>
                </div>
                <div class="form-group">
                    <label for="adminPassword">å¯†ç¢¼ï¼š</label>
                    <input type="password" id="adminPassword" required>
                </div>
                <button type="submit" class="btn" style="width: 100%; margin-top: 1rem;">ç™»å…¥</button>
            </form>
        </div>
    </div>

    <!-- Error Report Modal -->
    <div class="modal" id="reportErrorModal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close" onclick="closeModal('reportErrorModal')">Ã—</button>
            <h2 style="margin-bottom: 2rem; text-align: center; font-family: var(--chinese-title-font);">å›å ±éŒ¯å­—/å•é¡Œ</h2>
            <form id="reportErrorForm">
                <input type="hidden" id="errorReportDocId" value="">
                <div class="form-group">
                    <label for="errorReportPageUrl">å•é¡Œé é¢ (è‡ªå‹•å¡«å…¥):</label>
                    <input type="text" id="errorReportPageUrl" readonly>
                </div>
                <div class="form-group">
                    <label for="errorReportContext">å•é¡Œç›¸é—œå…§å®¹ (è‡ªå‹•æˆªå–éƒ¨åˆ†):</label>
                    <textarea id="errorReportContext" rows="3" readonly></textarea>
                </div>
                <div class="form-group">
                    <label for="errorReportDescription">è«‹æè¿°æ‚¨ç™¼ç¾çš„å•é¡Œ <span style="color:var(--text-accent)">*</span>:</label>
                    <textarea id="errorReportDescription" rows="5" required placeholder="ä¾‹å¦‚ï¼šç¬¬Xæ®µç¬¬Yè¡Œï¼ŒæŸå€‹å­—æ‡‰ç‚ºZ..."></textarea>
                </div>
                <div class="form-group">
                    <label for="errorReportEmail">æ‚¨çš„Email (æ–¹ä¾¿æˆ‘å€‘å›è¦†ï¼Œé¸å¡«):</label>
                    <input type="email" id="errorReportEmail" placeholder="your.email@example.com">
                </div>
                <button type="submit" class="btn" style="width: 100%; margin-top: 1rem;">æäº¤å›å ±</button>
            </form>
        </div>
    </div>

    <!-- Message Area -->
    <div id="messageArea"></div>

    <!-- Footer -->
    <footer style="text-align: center; padding: 3rem; background: rgba(0, 0, 0, 0.3); color: var(--text-light); font-size: 0.9rem;">
        <div class="social-links" style="margin-bottom: 1.5rem;">
            <a href="https://www.facebook.com/rigzinchenpoassociation/?locale=zh_TW" target="_blank" title="Facebook" style="color: var(--text-light); text-decoration: none; margin: 0 1rem; padding: 0.8rem; border-radius: var(--border-radius-small); transition: background 0.2s;">ğŸ“˜ Facebook</a>
            <a href="http://www.rigzin-chenpo.org/index2.html" target="_blank" title="Website" style="color: var(--text-light); text-decoration: none; margin: 0 1rem; padding: 0.8rem; border-radius: var(--border-radius-small); transition: background 0.2s;">ğŸ  å®˜æ–¹ç¶²ç«™</a>
        </div>
        <div class="copyright" style="opacity: 0.8;">
            å™¶é™€ä»çåƒå¯¶ Â© 2025 æ‰æ—ºè«¾å¸ƒæ–‡é›† All Rights Reserved
        </div>
    </footer>

    <script>
        // === å…¨å±€è®Šé‡ ===
        let documentsData = [];
        let currentMode = '';
        let isAdminLoggedIn = false;
        let currentOpenDocId = null;
        let isLeftSidebarActive = false;
        let favorites = [];
        let dataLoaded = false;
        let authToken = null;

        // API Base URL
        const API_BASE_URL = '';

        // === å·¥å…·å‡½æ•¸ ===
        function showMessage(text, type = 'info') {
            const msgArea = document.getElementById('messageArea');
            const msgEl = document.createElement('div');
            
            msgEl.className = `message ${type}`;
            msgEl.textContent = text;
            
            msgArea.appendChild(msgEl);
            
            setTimeout(() => {
                msgEl.style.animation = 'slideOutRight 0.4s ease-out forwards';
                setTimeout(() => {
                    if (msgArea.contains(msgEl)) {
                        msgArea.removeChild(msgEl);
                    }
                }, 400);
            }, 4000);
        }

        function setLoading(element, loading = true) {
            if (loading) {
                element.classList.add('loading');
            } else {
                element.classList.remove('loading');
            }
        }

        // === å´é‚Šæ¬„æ§åˆ¶ ===
        function toggleLeftSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContentArea');
            const toggleBtn = document.getElementById('toggleSidebarBtn');
            
            isLeftSidebarActive = !isLeftSidebarActive;
            
            if (isLeftSidebarActive) {
                sidebar.classList.add('active');
                mainContent.classList.add('sidebar-active');
                toggleBtn.innerHTML = 'âœ•';
            } else {
                sidebar.classList.remove('active');
                mainContent.classList.remove('sidebar-active');
                toggleBtn.innerHTML = 'â˜°';
            }
        }

        function toggleUtilitySidebar() {
            const sidebar = document.getElementById('utilitySidebarEl');
            const mainContent = document.getElementById('mainContentArea');
            const isActive = sidebar.classList.contains('active');
            
            if (isActive) {
                sidebar.classList.remove('active');
                mainContent.classList.remove('with-right-sidebar');
            } else {
                sidebar.classList.add('active');
                mainContent.classList.add('with-right-sidebar');
            }
        }

        // === æ¨¡å¼ç®¡ç† ===
        function enterMode(mode) {
            console.log('Entering mode:', mode);
            currentMode = mode;
            
            if (mode === 'edit') {
                if (!isAdminLoggedIn) {
                    showModal('adminLoginModal');
                    return;
                }
                setupEditMode();
            } else {
                setupReadMode();
            }
            
            document.getElementById('modeSelectorScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            document.body.classList.add('app-active');
            document.body.classList.remove('read-mode', 'edit-mode');
            document.body.classList.add(mode + '-mode');
            
            updateNavControls();
            loadContent();
        }

        function showModeSelectorScreen() {
            currentMode = '';
            isAdminLoggedIn = false;
            authToken = null;
            localStorage.removeItem('adminAuthToken');
            
            document.getElementById('modeSelectorScreen').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            document.body.classList.remove('app-active', 'read-mode', 'edit-mode');
            
            updateNavControls();
            
            // é‡ç½®å´é‚Šæ¬„
            if (isLeftSidebarActive) toggleLeftSidebar();
            if (document.getElementById('utilitySidebarEl').classList.contains('active')) {
                toggleUtilitySidebar();
            }
        }

        function setupReadMode() {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
            renderDocuments();
        }

        function setupEditMode() {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-flex');
            renderDocuments();
        }

        // === å°èˆªæ§åˆ¶ ===
        function updateNavControls() {
            const navRight = document.getElementById('navRightControls');
            navRight.innerHTML = '';
            
            if (currentMode === 'edit' && isAdminLoggedIn) {
                navRight.innerHTML = `
                    <button class="top-nav-btn admin-only" onclick="addNewDocument()">âœ¨ æ–°å¢</button>
                    <div style="color:var(--text-light); display:flex; align-items:center; gap:0.5rem; font-size:13px;" class="admin-only">
                        <span>ç®¡ç†å“¡</span>
                        <div style="width:20px; height:20px; background:var(--text-accent); border-radius:50%; text-align:center; line-height:20px; font-weight:bold; font-size:11px;">A</div>
                    </div>
                    <button class="top-nav-btn admin-only" onclick="adminLogout()">ç™»å‡º</button>
                `;
            } else if (currentMode === 'read') {
                navRight.innerHTML = `
                    <button class="top-nav-btn reader-only" onclick="showTools()">ğŸ› ï¸ å·¥å…·</button>
                    <button class="top-nav-btn" onclick="enterMode('edit')">ğŸ” ç™»å…¥</button>
                `;
            } else {
                navRight.innerHTML = `
                    <button class="top-nav-btn" onclick="showTools()">ğŸ› ï¸ å·¥å…·</button>
                    <button class="top-nav-btn" onclick="enterMode('edit')">ğŸ” ç™»å…¥</button>
                `;
            }
            
            // æ›´æ–°é¡¯ç¤ºç‹€æ…‹
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = (currentMode === 'edit' && isAdminLoggedIn) ? 'inline-flex' : 'none';
            });
            document.querySelectorAll('.reader-only').forEach(el => {
                el.style.display = (currentMode === 'read') ? (el.tagName === 'BUTTON' ? 'inline-flex' : 'block') : 'none';
            });
        }

        // === æ¨¡æ…‹æ¡†æ§åˆ¶ ===
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
            if (modalId === 'documentModal') {
                currentOpenDocId = null;
            }
        }

        // === ç®¡ç†å“¡åŠŸèƒ½ ===
        async function adminLogin(username, password) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (!response.ok) {
                    const errorResult = await response.json().catch(() => ({ message: `ç™»å…¥å¤±æ•—: ${response.status}` }));
                    throw new Error(errorResult.message || `ç™»å…¥å¤±æ•—: ${response.status}`);
                }

                const result = await response.json();
                if (result.success && result.token) {
                    authToken = result.token;
                    localStorage.setItem('adminAuthToken', result.token);
                    isAdminLoggedIn = true;
                    return true;
                } else {
                    throw new Error(result.message || "ç™»å…¥æ†‘è­‰ç„¡æ•ˆã€‚");
                }
            } catch (error) {
                console.error("ç®¡ç†å“¡ç™»å…¥å¤±æ•—:", error);
                throw error;
            }
        }

        function adminLogout() {
            isAdminLoggedIn = false;
            authToken = null;
            localStorage.removeItem('adminAuthToken');
            showMessage('å·²ç™»å‡ºç®¡ç†å“¡æ¨¡å¼', 'info');
            
            currentMode = 'read';
            document.body.classList.remove('edit-mode');
            document.body.classList.add('read-mode');
            
            setupReadMode();
            updateNavControls();
            renderDocuments();
        }

        // === æ•¸æ“šç®¡ç† ===
        async function loadDocumentsData() {
            console.log("å‰ç«¯ï¼šæ­£åœ¨å¾å¾Œç«¯è¼‰å…¥æ–‡ç»è³‡æ–™...");
            try {
                const response = await fetch(`${API_BASE_URL}/api/documents`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }
                
                const fetchedData = await response.json();
                if (!Array.isArray(fetchedData)) {
                    console.error("å¾ API ç²å–çš„æ•¸æ“šä¸æ˜¯é™£åˆ—:", fetchedData);
                    documentsData = [];
                    throw new Error("å¾ä¼ºæœå™¨æ¥æ”¶åˆ°ç„¡æ•ˆçš„æ•¸æ“šæ ¼å¼ã€‚");
                }
                
                documentsData = fetchedData;
                console.log("å‰ç«¯ï¼šæ–‡ç»è³‡æ–™è¼‰å…¥å®Œæˆã€‚æ•¸é‡:", documentsData.length);
                
                processAllDocumentMeta();
                dataLoaded = true;
                return true;
            } catch (error) {
                console.error("å‰ç«¯ç„¡æ³•å¾ä¼ºæœå™¨ç²å–æ–‡ç»è³‡æ–™:", error);
                showMessage(`éŒ¯èª¤ï¼šç„¡æ³•å¾ä¼ºæœå™¨è¼‰å…¥æ–‡ç»è³‡æ–™ã€‚(${error.message})`, 'error');
                documentsData = [];
                dataLoaded = false;
                return false;
            }
        }

        function processAllDocumentMeta() {
            documentsData.forEach(doc => {
                if (!doc.meta) doc.meta = {};
                
                const plainTibetan = (doc.ContentTibetan || "").replace(/<[^>]+>/g, "");
                const plainChinese = (doc.ContentChinese || "").replace(/<[^>]+>/g, "");
                const plainEnglish = (doc.ContentEnglish || "").replace(/<[^>]+>/g, "");
                
                const tibetanSyllables = plainTibetan.split(/[à¼‹\s]+/).filter(s => s.trim().length > 0).length;
                const chineseChars = plainChinese.replace(/[^\u4e00-\u9fa5]/g, "").length;
                const englishWords = plainEnglish.split(/\s+/).filter(s => s.trim().length > 0).length;
                
                let wordsDescription = [];
                if (tibetanSyllables > 0) wordsDescription.push(`è— ${tibetanSyllables} éŸ³ç¯€`);
                if (chineseChars > 0) wordsDescription.push(`ä¸­ ${chineseChars} å­—`);
                if (englishWords > 0) wordsDescription.push(`è‹± ${englishWords} è©`);
                doc.meta.words = wordsDescription.join(' | ') || "N/A";
                
                const readTimeMinutes = Math.ceil((chineseChars / 250) + (tibetanSyllables / 150) + (englishWords / 200));
                doc.meta.readTime = `é–±è®€ç´„ ${readTimeMinutes} åˆ†é˜`;
                doc.meta.pages = `${Math.ceil(readTimeMinutes / 5)} é  (ä¼°ç®—)`;
                
                doc.meta.preview = doc.meta.preview || (plainChinese || plainTibetan || plainEnglish).substring(0, 100).replace(/<[^>]+>/g, '') + "...";
            });
        }

        async function loadContent() {
            if (!dataLoaded) {
                const success = await loadDocumentsData();
                if (success) {
                    renderSidebar();
                    renderDocuments();
                } else {
                    document.getElementById('documentsGridEl').innerHTML = `
                        <div style="text-align:center;padding:3rem;color:var(--text-light);opacity:0.8;grid-column: 1/-1;">
                            <h3 style="margin-bottom:1rem;">ç„¡æ³•è¼‰å…¥æ–‡ç»è³‡æ–™</h3>
                            <p>è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚</p>
                        </div>
                    `;
                    document.getElementById('totalCountEl').textContent = '0';
                }
            } else {
                console.log("æ–‡ç»è³‡æ–™å·²è¼‰å…¥æˆ–å·²å˜—è©¦è¼‰å…¥ã€‚");
                renderSidebar();
                renderDocuments();
            }
        }

        // === å…§å®¹æ¸²æŸ“ ===
        function renderSidebar() {
            const sidebarEl = document.getElementById('courseMenuContainer');
            
            if (!documentsData || documentsData.length === 0) {
                sidebarEl.innerHTML = '<div style="padding:1rem;color:var(--text-light);opacity:0.8;">æš«ç„¡ç›®éŒ„</div>';
                return;
            }
            
            const categories = {};
            documentsData.forEach(doc => {
                const cat = doc.category || 'æœªåˆ†é¡';
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push(doc);
            });
            
            sidebarEl.innerHTML = Object.entries(categories).map(([category, docs]) => {
                const categoryId = `category-list-${category.replace(/[^a-zA-Z0-9\-_]/g, '')}`;
                return `
                    <div style="margin-bottom:1rem;">
                        <h4 style="padding:1rem;background:rgba(255,255,255,0.1);margin:0;cursor:pointer;border-radius:var(--border-radius-small);transition:all 0.3s ease;" 
                           onclick="toggleCategory('${categoryId}')"
                           onmouseover="this.style.background='rgba(255,255,255,0.2)'" 
                           onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                            ${category} (${docs.length})
                        </h4>
                        <div id="${categoryId}" style="padding-left:1rem;display:block;">
                            ${docs.map(doc => `
                                <div style="padding:0.8rem 1rem;cursor:pointer;border-radius:var(--border-radius-small);margin:0.3rem 0;display:flex;justify-content:space-between;align-items:center;transition:all 0.3s ease;" 
                                     onclick="openDocument('${doc.id}')" 
                                     onmouseover="this.style.background='rgba(255,255,255,0.15);this.style.transform='translateX(5px)'" 
                                     onmouseout="this.style.background='transparent';this.style.transform='translateX(0)'">
                                    <span style="flex-grow:1;">${doc.chineseTitle || doc.tibetanTitle || 'ç„¡æ¨™é¡Œ'}</span>
                                    <span style="font-size:0.75em;opacity:0.6;margin-left:8px;white-space:nowrap;">[${(doc.availableLanguages || []).join(',')}]</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleCategory(categoryId) {
            const catEl = document.getElementById(categoryId);
            if (catEl) {
                const isHidden = catEl.style.display === 'none';
                catEl.style.display = isHidden ? 'block' : 'none';
            }
        }

        function renderDocuments(docsToRender = documentsData) {
            const gridEl = document.getElementById('documentsGridEl');
            const totalEl = document.getElementById('totalCountEl');
            
            if (!docsToRender || docsToRender.length === 0) {
                gridEl.innerHTML = `
                    <div style="text-align:center;padding:3rem;color:var(--text-light);opacity:0.8;grid-column: 1/-1;">
                        <h3 style="margin-bottom:1rem;">${currentMode === 'edit' && isAdminLoggedIn ? 'å°šç„¡æ–‡ç»' : 'æš«ç„¡æ–‡ç»è³‡æ–™'}</h3>
                        <p>${currentMode === 'edit' && isAdminLoggedIn ? 'é»æ“Šä¸Šæ–¹ "âœ¨ æ–°å¢" ä¾†å»ºç«‹ç¬¬ä¸€ä»½æ–‡ç»' : 'è«‹ç¨å¾Œå†è©¦æˆ–è¯ç¹«ç®¡ç†å“¡'}</p>
                    </div>
                `;
                totalEl.textContent = '0';
                return;
            }
            
            totalEl.textContent = docsToRender.length;
            
            gridEl.innerHTML = docsToRender.map(doc => `
                <div class="document-card">
                    <h3 class="document-title">${doc.tibetanTitle || 'ç„¡è—æ–‡æ¨™é¡Œ'}</h3>
                    <h4 class="document-subtitle">${doc.chineseTitle || 'ç„¡ä¸­æ–‡æ¨™é¡Œ'}</h4>
                    <div class="document-meta">
                        ä½œè€…ï¼š${doc.author || 'æœªçŸ¥'} | é¡åˆ¥ï¼š${doc.category || 'æœªåˆ†é¡'}
                        ${doc.meta ? ` | ${doc.meta.words}` : ''}
                    </div>
                    <div class="document-preview">
                        ${doc.meta?.preview || (doc.ContentChinese || doc.ContentTibetan || doc.ContentEnglish || '').substring(0, 100).replace(/<[^>]+>/g, '')}...
                    </div>
                    <div class="document-card-actions">
                        <button class="btn" onclick="event.stopPropagation(); openDocument('${doc.id}');">ğŸ“– é–±è®€å…¨æ–‡</button>
                        <button class="btn admin-only" onclick="event.stopPropagation(); editDocument('${doc.id}');" 
                                style="background: rgba(255, 215, 0, 0.2); border-color: var(--text-accent);">âœ ç·¨è¼¯</button>
                        <button class="btn admin-only" onclick="event.stopPropagation(); deleteDocument('${doc.id}');" 
                                style="background: rgba(220, 53, 69, 0.2); border-color: #dc3545;">ğŸ—‘ï¸ åˆªé™¤</button>
                        <button class="like-btn reader-only ${favorites.includes(doc.id) ? 'liked' : ''}" 
                                onclick="event.stopPropagation(); toggleFavorite('${doc.id}', this);" 
                                title="æ”¶è—">â¤ï¸</button>
                    </div>
                </div>
            `).join('');
            
            // æ›´æ–°é¡¯ç¤ºç‹€æ…‹
            document.querySelectorAll('.document-card .admin-only').forEach(el => {
                el.style.display = (currentMode === 'edit' && isAdminLoggedIn) ? 'inline-flex' : 'none';
            });
            document.querySelectorAll('.document-card .reader-only').forEach(el => {
                el.style.display = (currentMode === 'read') ? 'inline-flex' : 'none';
            });
        }

        // === æ”¶è—åŠŸèƒ½ ===
        function loadFavorites() {
            const storedFavorites = localStorage.getItem('sunbumFavorites');
            if (storedFavorites) {
                try {
                    favorites = JSON.parse(storedFavorites);
                } catch (e) {
                    console.error('è¼‰å…¥æ”¶è—å¤±æ•—:', e);
                    favorites = [];
                }
            }
        }

        function saveFavorites() {
            localStorage.setItem('sunbumFavorites', JSON.stringify(favorites));
        }

        function toggleFavorite(docId, btnElement) {
            const index = favorites.indexOf(docId);
            if (index > -1) {
                favorites.splice(index, 1);
                btnElement.classList.remove('liked');
                showMessage('å·²å–æ¶ˆæ”¶è—', 'info');
            } else {
                favorites.push(docId);
                btnElement.classList.add('liked');
                showMessage('å·²åŠ å…¥æ”¶è—ï¼', 'success');
            }
            saveFavorites();
            updateFavoritesList();
        }

        function removeFavorite(docId) {
            const index = favorites.indexOf(docId);
            if (index > -1) {
                favorites.splice(index, 1);
                saveFavorites();
            }
        }

        function updateFavoritesList() {
            const container = document.getElementById('favoritesListContainerEl');
            if (favorites.length === 0) {
                container.innerHTML = '<p style="opacity:0.7;padding:1rem;">æš«ç„¡æ”¶è—æ–‡ç« ã€‚</p>';
                return;
            }
            
            container.innerHTML = favorites.map(favId => {
                const doc = documentsData.find(d => d.id === favId);
                return doc ? `
                    <div class="favorite-item" onclick="openDocument('${doc.id}'); toggleUtilitySidebar();" 
                         style="padding:0.8rem;margin-bottom:0.5rem;background:rgba(255,255,255,0.1);border-radius:var(--border-radius-small);cursor:pointer;transition:all 0.3s ease;"
                         onmouseover="this.style.background='rgba(255,255,255,0.2)'"
                         onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                        ${doc.chineseTitle || doc.tibetanTitle || 'æœªçŸ¥æ–‡ç¨¿'}
                    </div>
                ` : '';
            }).join('');
        }

        function showFavorites() {
            const favContainer = document.getElementById('favoritesListContainerEl');
            const isVisible = favContainer.style.display !== 'none';
            favContainer.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) updateFavoritesList();
        }

        // === æ–‡æª”æ¨¡æ…‹æ¡† ===
        function openDocument(docId) {
            const doc = documentsData.find(d => d.id === docId);
            if (!doc) {
                showMessage('æ‰¾ä¸åˆ°è©²æ–‡ä»¶', 'error');
                return;
            }
            
            currentOpenDocId = docId;
            
            // è¨­ç½®æ¨™é¡Œ
            document.querySelector('#modalHeaderContent .modal-document-title-zh').textContent = doc.chineseTitle || '';
            document.querySelector('#modalHeaderContent .modal-document-title-bo').textContent = doc.tibetanTitle || '';
            document.querySelector('#modalHeaderContent .modal-document-title-en').textContent = doc.englishTitle || '';
            
            // è¨­ç½®å…§å®¹
            const tibetanDiv = document.getElementById('modalTibetanContentEl');
            const chineseDiv = document.getElementById('modalChineseContentEl');
            const englishDiv = document.getElementById('modalEnglishContentEl');
            
            const hasTibetan = doc.ContentTibetan && doc.ContentTibetan.replace(/<[^>]+>|\s+/g, '') !== '';
            const hasChinese = doc.ContentChinese && doc.ContentChinese.replace(/<[^>]+>|\s+/g, '') !== '';
            const hasEnglish = doc.ContentEnglish && doc.ContentEnglish.replace(/<[^>]+>|\s+/g, '') !== '';
            
            tibetanDiv.innerHTML = hasTibetan ? 
                `<h4>è—æ–‡åŸæ–‡</h4>${doc.ContentTibetan}` : 
                `<h4>è—æ–‡åŸæ–‡</h4><p style="opacity:0.7;">æš«ç„¡è—æ–‡å…§å®¹</p>`;
                
            chineseDiv.innerHTML = hasChinese ? 
                `<h4>ä¸­æ–‡ç¿»è­¯</h4>${doc.ContentChinese}` : 
                `<h4>ä¸­æ–‡ç¿»è­¯</h4><p style="opacity:0.7;">æš«ç„¡ä¸­æ–‡å…§å®¹</p>`;
                
            englishDiv.innerHTML = hasEnglish ? 
                `<h4>English Translation</h4>${doc.ContentEnglish}` : 
                `<h4>English Translation</h4><p style="opacity:0.7;">No English content.</p>`;
            
            // è¨­ç½®å…ƒæ•¸æ“š
            const metaInfo = [
                `<strong>ä½œè€…ï¼š</strong>${doc.author || 'æœªçŸ¥'}`,
                `<strong>é¡åˆ¥ï¼š</strong>${doc.category || 'æœªåˆ†é¡'}`
            ];
            
            if (doc.tags && doc.tags.length) {
                metaInfo.push(`<strong>æ¨™ç±¤ï¼š</strong>${doc.tags.join(', ')}`);
            }
            
            if (doc.meta) {
                metaInfo.push(`<strong>å­—æ•¸ï¼š</strong>${doc.meta.words}`);
                metaInfo.push(`<strong>é–±è®€æ™‚é–“ï¼š</strong>${doc.meta.readTime}`);
            }
            
            document.getElementById('modalMetaContent').innerHTML = metaInfo.join(' | ');
            
            // æ›´æ–°èªè¨€åˆ‡æ›å™¨
            updateLanguageSwitcher(doc.availableLanguages || [], docId);
            
            // é¸æ“‡é»˜èªé¡¯ç¤ºèªè¨€
            let initialLang = '';
            if (hasTibetan && hasChinese) initialLang = 'bo-zh';
            else if (hasTibetan) initialLang = 'bo';
            else if (hasChinese) initialLang = 'zh';
            else if (hasEnglish) initialLang = 'en';
            
            if (initialLang) {
                showLanguage(docId, initialLang);
            }
            
            showModal('documentModal');
        }

        function updateLanguageSwitcher(availableLangs, docId) {
            const switcherEl = document.getElementById('languageSwitcherModal');
            switcherEl.innerHTML = '';
            
            const langMap = { bo: 'è—æ–‡', zh: 'ä¸­æ–‡', en: 'English' };
            
            const hasContent = (lang) => {
                const doc = documentsData.find(d => d.id === docId);
                if (!doc) return false;
                if (lang === 'bo') return doc.ContentTibetan && doc.ContentTibetan.replace(/<[^>]+>|\s+/g, '') !== '';
                if (lang === 'zh') return doc.ContentChinese && doc.ContentChinese.replace(/<[^>]+>|\s+/g, '') !== '';
                if (lang === 'en') return doc.ContentEnglish && doc.ContentEnglish.replace(/<[^>]+>|\s+/g, '') !== '';
                return false;
            };
            
            // å–®èªè¨€æŒ‰éˆ•
            availableLangs.forEach(lang => {
                if (langMap[lang] && hasContent(lang)) {
                    const btn = document.createElement('button');
                    btn.textContent = langMap[lang];
                    btn.onclick = () => showLanguage(docId, lang);
                    btn.dataset.langCode = lang;
                    btn.className = 'language-switcher-modal button';
                    switcherEl.appendChild(btn);
                }
            });
            
            // å°ç…§æŒ‰éˆ•
            const bilingualOptions = [
                { code: 'bo-zh', label: 'è—ä¸­å°ç…§', langs: ['bo', 'zh'] },
                { code: 'bo-en', label: 'è—è‹±å°ç…§', langs: ['bo', 'en'] },
                { code: 'zh-en', label: 'ä¸­è‹±å°ç…§', langs: ['zh', 'en'] }
            ];
            
            bilingualOptions.forEach(option => {
                if (option.langs.every(lang => availableLangs.includes(lang) && hasContent(lang))) {
                    const btn = document.createElement('button');
                    btn.textContent = option.label;
                    btn.onclick = () => showLanguage(docId, option.code);
                    btn.dataset.langCode = option.code;
                    btn.className = 'language-switcher-modal button';
                    switcherEl.appendChild(btn);
                }
            });
            
            if (switcherEl.children.length === 0) {
                switcherEl.innerHTML = '<p style="opacity:0.7;">æ­¤æ–‡ç»æš«ç„¡å…§å®¹å¯ä¾›é¡¯ç¤ºã€‚</p>';
            }
        }

        function showLanguage(docId, langCode) {
            const doc = documentsData.find(d => d.id === docId);
            if (!doc) return;
            
            const tibetanDiv = document.getElementById('modalTibetanContentEl');
            const chineseDiv = document.getElementById('modalChineseContentEl');
            const englishDiv = document.getElementById('modalEnglishContentEl');
            const sep1 = document.getElementById('modalLanguageSeparator');
            const sep2 = document.getElementById('modalLanguageSeparator2');
            
            // éš±è—æ‰€æœ‰å…§å®¹
            [tibetanDiv, chineseDiv, englishDiv].forEach(d => d.style.display = 'none');
            [sep1, sep2].forEach(s => s.style.display = 'none');
            
            // æ›´æ–°æ´»å‹•æŒ‰éˆ•
            document.getElementById('languageSwitcherModal').querySelectorAll('button').forEach(b => {
                b.classList.remove('active');
                if (b.dataset.langCode === langCode) b.classList.add('active');
            });
            
            const hasTibetan = doc.ContentTibetan && doc.ContentTibetan.replace(/<[^>]+>|\s+/g, '') !== '';
            const hasChinese = doc.ContentChinese && doc.ContentChinese.replace(/<[^>]+>|\s+/g, '') !== '';
            const hasEnglish = doc.ContentEnglish && doc.ContentEnglish.replace(/<[^>]+>|\s+/g, '') !== '';
            
            // æ ¹æ“šèªè¨€ä»£ç¢¼é¡¯ç¤ºå…§å®¹
            if (langCode === 'bo' && hasTibetan) {
                tibetanDiv.style.display = 'block';
            } else if (langCode === 'zh' && hasChinese) {
                chineseDiv.style.display = 'block';
            } else if (langCode === 'en' && hasEnglish) {
                englishDiv.style.display = 'block';
            } else if (langCode === 'bo-zh') {
                if (hasTibetan) tibetanDiv.style.display = 'block';
                if (hasTibetan && hasChinese) sep1.style.display = 'block';
                if (hasChinese) chineseDiv.style.display = 'block';
            } else if (langCode === 'bo-en') {
                if (hasTibetan) tibetanDiv.style.display = 'block';
                if (hasTibetan && hasEnglish) sep1.style.display = 'block';
                if (hasEnglish) englishDiv.style.display = 'block';
            } else if (langCode === 'zh-en') {
                if (hasChinese) chineseDiv.style.display = 'block';
                if (hasChinese && hasEnglish) sep1.style.display = 'block';
                if (hasEnglish) englishDiv.style.display = 'block';
            }
        }

        // === ç®¡ç†å“¡æ“ä½œ ===
        async function addNewDocument() {
            const newDocData = {
                tibetanTitle: prompt("è¼¸å…¥æ–°æ–‡æª”çš„è—æ–‡æ¨™é¡Œ:", "æ–°è—æ–‡æ¨™é¡Œ") || "æœªå‘½åè—æ–‡æ–‡ç¨¿",
                chineseTitle: prompt("è¼¸å…¥æ–°æ–‡æª”çš„ä¸­æ–‡æ¨™é¡Œ:", "æ–°ä¸­æ–‡æ¨™é¡Œ") || "æœªå‘½åä¸­æ–‡æ–‡ç¨¿",
                englishTitle: prompt("è¼¸å…¥æ–°æ–‡æª”çš„è‹±æ–‡æ¨™é¡Œ:", "New English Title") || "",
                author: prompt("è¼¸å…¥ä½œè€…:", "ç®¡ç†å“¡") || "æœªçŸ¥ä½œè€…",
                category: prompt("è¼¸å…¥åˆ†é¡:", "æ–°åˆ†é¡") || "æœªåˆ†é¡",
                tags: (prompt("è¼¸å…¥æ¨™ç±¤ (é€—è™Ÿåˆ†éš”):", "æ–°æ¨™ç±¤,æ¸¬è©¦") || "").split(',').map(t => t.trim()).filter(t => t),
                ContentTibetan: `<p class='tibetan-text'>${prompt("è¼¸å…¥è—æ–‡å…§å®¹:", "æ­¤è™•ç‚ºè—æ–‡å…§å®¹...") || ""}</p>`,
                ContentChinese: `<p class='chinese-text'>${prompt("è¼¸å…¥ä¸­æ–‡å…§å®¹:", "æ­¤è™•ç‚ºä¸­æ–‡å…§å®¹...") || ""}</p>`,
                ContentEnglish: `<p class='english-text'>${prompt("è¼¸å…¥è‹±æ–‡å…§å®¹:", "English content here...") || ""}</p>`,
                availableLanguages: [],
                status: "draft"
            };
            
            // æª¢æŸ¥å¯ç”¨èªè¨€
            if (newDocData.ContentTibetan.replace(/<[^>]+>|\s+/g, '') !== '') newDocData.availableLanguages.push('bo');
            if (newDocData.ContentChinese.replace(/<[^>]+>|\s+/g, '') !== '') newDocData.availableLanguages.push('zh');
            if (newDocData.ContentEnglish.replace(/<[^>]+>|\s+/g, '') !== '') newDocData.availableLanguages.push('en');
            
            if (!newDocData.chineseTitle && !newDocData.tibetanTitle) {
                showMessage('å¿…é ˆè‡³å°‘æä¾›ä¸€å€‹æ¨™é¡Œã€‚', 'error');
                return;
            }

            console.log("æº–å‚™æ–°å¢æ–‡ç» (å°‡ç™¼é€åˆ°å¾Œç«¯):", newDocData);
            showMessage('æ­£åœ¨å˜—è©¦æ–°å¢æ–‡ç»åˆ°ä¼ºæœå™¨...', 'info');
            
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
                
                const response = await fetch(`${API_BASE_URL}/api/documents`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(newDocData)
                });
                
                if (!response.ok) throw new Error(`ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`);
                const savedDoc = await response.json();

                documentsData.unshift(savedDoc);
                renderDocuments();
                renderSidebar();
                showMessage(`æ–‡ç» "${savedDoc.chineseTitle || savedDoc.tibetanTitle}" å·²æˆåŠŸæ–°å¢ã€‚`, 'success');
                openDocument(savedDoc.id);
            } catch (error) {
                console.error("æ–°å¢æ–‡ç»å¤±æ•—:", error);
                showMessage(`æ–°å¢æ–‡ç»å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function editDocument(docId) {
            const doc = documentsData.find(d => d.id === docId);
            if (!doc) {
                showMessage('æ‰¾ä¸åˆ°è¦ç·¨è¼¯çš„æ–‡ç»', 'error');
                return;
            }

            const updatedData = { ...doc };
            const newChineseTitle = prompt("ç·¨è¼¯ä¸­æ–‡æ¨™é¡Œ:", updatedData.chineseTitle);
            if (newChineseTitle !== null) updatedData.chineseTitle = newChineseTitle;

            console.log(`æº–å‚™æ›´æ–°æ–‡ç» ${docId} (å°‡ç™¼é€åˆ°å¾Œç«¯):`, updatedData);
            showMessage(`æ­£åœ¨å˜—è©¦æ›´æ–°æ–‡ç» "${docId}" åˆ°ä¼ºæœå™¨...`, 'info');
            
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
                
                const response = await fetch(`${API_BASE_URL}/api/documents/${docId}`, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify(updatedData)
                });
                
                if (!response.ok) throw new Error(`ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`);
                const savedDoc = await response.json();

                const index = documentsData.findIndex(d => d.id === docId);
                if (index > -1) documentsData[index] = savedDoc;

                renderDocuments();
                renderSidebar();
                if (currentOpenDocId === docId && document.getElementById('documentModal').classList.contains('active')) {
                    openDocument(docId);
                }
                showMessage(`æ–‡ç» "${savedDoc.chineseTitle || savedDoc.tibetanTitle}" å·²æˆåŠŸæ›´æ–°ã€‚`, 'success');
            } catch (error) {
                console.error(`æ›´æ–°æ–‡ç» ${docId} å¤±æ•—:`, error);
                showMessage(`æ›´æ–°æ–‡ç»å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function deleteDocument(docId) {
            const doc = documentsData.find(d => d.id === docId);
            if (!doc) {
                showMessage('æ‰¾ä¸åˆ°è¦åˆªé™¤çš„æ–‡ç»', 'error');
                return;
            }

            if (confirm(`ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ–‡ç¨¿ "${doc.chineseTitle || doc.tibetanTitle}" å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                console.log(`æº–å‚™åˆªé™¤æ–‡ç» ${docId} (å°‡ç™¼é€åˆ°å¾Œç«¯)`);
                showMessage(`æ­£åœ¨å˜—è©¦å¾ä¼ºæœå™¨åˆªé™¤æ–‡ç» "${docId}"...`, 'info');
                
                try {
                    const headers = {};
                    if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
                    
                    const response = await fetch(`${API_BASE_URL}/api/documents/${docId}`, {
                        method: 'DELETE',
                        headers
                    });
                    
                    if (!response.ok) throw new Error(`ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`);

                    documentsData = documentsData.filter(d => d.id !== docId);
                    renderDocuments();
                    renderSidebar();
                    showMessage('æ–‡ç»å·²æˆåŠŸåˆªé™¤ã€‚', 'success');
                    if (currentOpenDocId === docId) closeModal('documentModal');
                    removeFavorite(docId);
                    updateFavoritesList();
                } catch (error) {
                    console.error(`åˆªé™¤æ–‡ç» ${docId} å¤±æ•—:`, error);
                    showMessage(`åˆªé™¤æ–‡ç»å¤±æ•—: ${error.message}`, 'error');
                }
            }
        }

        // === éŒ¯èª¤å›å ± ===
        async function submitErrorReport(reportData) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/report-error`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reportData)
                });

                if (!response.ok) {
                    const errorResult = await response.json().catch(() => ({ message: `ä¼ºæœå™¨éŒ¯èª¤: ${response.status}` }));
                    throw new Error(errorResult.message || `ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`);
                }

                const result = await response.json();
                return result;
            } catch (error) {
                console.error("æäº¤éŒ¯èª¤å›å ±å¤±æ•—:", error);
                throw error;
            }
        }

        function openReportErrorModal() {
            const form = document.getElementById('reportErrorForm');
            form.reset();
            document.getElementById('errorReportPageUrl').value = window.location.href;
            
            let context = "";
            if (currentOpenDocId && document.getElementById('documentModal').classList.contains('active')) {
                const doc = documentsData.find(d => d.id === currentOpenDocId);
                if (doc) {
                    document.getElementById('errorReportDocId').value = currentOpenDocId;
                    const activeLangBtn = document.querySelector('#languageSwitcherModal button.active');
                    let contentToSample = "";
                    if (activeLangBtn) {
                        const langCode = activeLangBtn.dataset.langCode;
                        if (langCode.includes('bo') && doc.ContentTibetan) contentToSample = doc.ContentTibetan;
                        else if (langCode.includes('zh') && doc.ContentChinese) contentToSample = doc.ContentChinese;
                        else if (langCode.includes('en') && doc.ContentEnglish) contentToSample = doc.ContentEnglish;
                    }
                    if (!contentToSample && doc.ContentChinese) contentToSample = doc.ContentChinese;
                    if (contentToSample) {
                        context = contentToSample.replace(/<[^>]+>/g, ' ').trim().substring(0, 150) + "...";
                    }
                }
            } else {
                document.getElementById('errorReportDocId').value = "N/A (éç‰¹å®šæ–‡ç¨¿)";
                context = "ç”¨æˆ¶åœ¨ä¸»åˆ—è¡¨é é¢å›å ±å•é¡Œã€‚";
            }
            document.getElementById('errorReportContext').value = context || "ç„¡æ³•è‡ªå‹•æˆªå–å…§å®¹ã€‚";
            showModal('reportErrorModal');
        }

        // === å·¥å…·å‡½æ•¸ ===
        function showTools() {
            toggleUtilitySidebar();
        }

        function showInfo(title) {
            const infoContent = {
                'é—œæ–¼æˆ‘å€‘': `æ‰æ—ºè«¾å¸ƒæ–‡é›†é–±è¦½é¤¨

é€™æ˜¯ä¸€å€‹è‡´åŠ›æ–¼ä¿å­˜å’Œå‚³æ’­æ‰æ—ºè«¾å¸ƒå¤§å¸«çè²´æ–‡ç»çš„æ•¸ä½å¹³å°ã€‚æˆ‘å€‘çš„ä½¿å‘½æ˜¯è®“æ›´å¤šäººèƒ½å¤ æ¥è§¸åˆ°é€™äº›å¯¶è²´çš„ç²¾ç¥è²¡å¯Œï¼Œä¿ƒé€²è—å‚³ä½›æ•™æ–‡åŒ–çš„å‚³æ‰¿èˆ‡äº¤æµã€‚

æˆ‘å€‘çš„é¡˜æ™¯ï¼š
â€¢ æ•¸ä½åŒ–ä¿å­˜çè²´æ–‡ç»
â€¢ æä¾›å¤šèªè¨€å°ç…§é–±è®€
â€¢ ä¿ƒé€²å­¸è¡“ç ”ç©¶èˆ‡äº¤æµ
â€¢ å‚³æ‰¿èˆ‡å¼˜æšä½›æ³•æ™ºæ…§

æ„Ÿè¬æ‚¨å°æˆ‘å€‘å·¥ä½œçš„æ”¯æŒèˆ‡é—œæ³¨ã€‚`,

                'ç·¨è€…çš„è©±': `ç·¨è€…çš„è©±

åœ¨æ•¸ä½æ™‚ä»£çš„ä»Šå¤©ï¼Œæˆ‘å€‘æ·±æ„Ÿæœ‰è²¬ä»»å°‡æ‰æ—ºè«¾å¸ƒå¤§å¸«çš„çè²´æ•™æ³•ä»¥ç¾ä»£åŒ–çš„æ–¹å¼å‘ˆç¾çµ¦å»£å¤§è®€è€…ã€‚é€™å€‹é–±è¦½é¤¨çš„å»ºç«‹ï¼Œæ˜¯æˆ‘å€‘å°å‚³çµ±æ–‡åŒ–å‚³æ‰¿çš„ä¸€ä»½è²¢ç»ã€‚

ç·¨è¼¯åŸå‰‡ï¼š
â€¢ å¿ å¯¦åŸæ–‡ï¼Œæº–ç¢ºç¿»è­¯
â€¢ å¤šèªè¨€å°ç…§ï¼Œä¾¿æ–¼ç†è§£
â€¢ æ•¸ä½åŒ–å‘ˆç¾ï¼Œæ–¹ä¾¿æª¢ç´¢
â€¢ é–‹æ”¾å…±äº«ï¼Œåˆ©ç›Šçœ¾ç”Ÿ

æˆ‘å€‘å°‡æŒçºŒåŠªåŠ›ï¼Œä¸æ–·å®Œå–„é€™å€‹å¹³å°ï¼Œç‚ºæ‰€æœ‰å°è—å‚³ä½›æ•™æ–‡åŒ–æ„Ÿèˆˆè¶£çš„æœ‹å‹æä¾›æ›´å¥½çš„å­¸ç¿’è³‡æºã€‚

ç·¨è¼¯å§”å“¡æœƒ
2025å¹´`,

                'åƒè€ƒè³‡æº': `åƒè€ƒè³‡æº

ç›¸é—œç¶²ç«™ï¼š
â€¢ å™¶é™€ä»çåƒå¯¶å®˜æ–¹ç¶²ç«™ï¼šhttp://www.rigzin-chenpo.org
â€¢ Facebook ç²‰çµ²å°ˆé ï¼šhttps://www.facebook.com/rigzinchenpoassociation

å­¸è¡“è³‡æºï¼š
â€¢ è—å‚³ä½›æ•™æ•¸ä½åœ–æ›¸é¤¨
â€¢ ç›¸é—œç ”ç©¶è«–æ–‡é›†
â€¢ å­¸è¡“æœƒè­°è³‡æ–™

æŠ€è¡“æ”¯æ´ï¼š
â€¢ è—æ–‡è¼¸å…¥æ³•å·¥å…·
â€¢ æ•¸ä½åŒ–æ–‡ç»æ¨™æº–
â€¢ å¤šåª’é«”å‘ˆç¾æŠ€è¡“

å¦‚éœ€æ›´å¤šè³‡æºæˆ–æœ‰ä»»ä½•å»ºè­°ï¼Œè«‹éš¨æ™‚èˆ‡æˆ‘å€‘è¯ç¹«ã€‚`
            };
            
            showInfoModal(title, infoContent[title] || 'å…§å®¹æº–å‚™ä¸­...');
        }

        function showInfoModal(title, content) {
            let modal = document.getElementById('infoModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'infoModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 700px;">
                        <button class="modal-close" onclick="closeModal('infoModal')">Ã—</button>
                        <h2 id="infoModalTitle" style="margin-bottom: 2rem; font-family: var(--chinese-title-font); text-align: center;"></h2>
                        <div id="infoModalContent" style="line-height: 1.8; white-space: pre-wrap; font-family: var(--chinese-content-font);"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            document.getElementById('infoModalTitle').textContent = title;
            document.getElementById('infoModalContent').textContent = content;
            showModal('infoModal');
        }

        function showUtilityModal(modalType, title) {
            if (modalType === 'donateModal') {
                const donateContent = `ç™¼å¿ƒè´ŠåŠ©å¸³è™Ÿ

1ã€æˆ¶åï¼šä¸­è¯æ°‘åœ‹å™¶é™€ä»çåƒå¯¶ä½›å­¸æœƒ
   éƒµå±€åŠƒæ’¥å¸³è™Ÿï¼š18856281

2ã€è½‰å¸³æˆ–åŒ¯æ¬¾éŠ€è¡Œï¼šå°åŒ—å¯Œé‚¦å•†æ¥­éŠ€è¡Œä¿¡ç¾©åˆ†è¡Œ
   æˆ¶åï¼šä¸­è¯æ°‘åœ‹å™¶é™€ä»çåƒå¯¶ä½›å­¸æœƒ / ç´€éœå®œ
   Swift Codeï¼šTPBKTWTP460
   éŠ€è¡Œå¸³è™Ÿï¼š460-210836692

3ã€æµ·å¤–åŒ¯æ¬¾ï¼š
   Beneficiaryï¼šKathog Rigzin Chenpo Dharma Association
   Bankï¼šTAIPEI FUBON COMMERCIAL BANK CO., LTD (Hsinyi Branch)
   Swift Codeï¼šTPBKTWTP460
   Account No.ï¼š460-210836692

æ„Ÿè¬æ‚¨çš„è­·æŒèˆ‡æ”¯æŒï¼`;
                
                showInfoModal(title, donateContent);
            } else {
                showMessage(`${title} åŠŸèƒ½é–‹ç™¼ä¸­...`, 'info');
            }
        }

        function contactSupport() {
            const contactContent = `è¯ç¹«å®¢æœ

ğŸ“ é›»è©±ï¼š0968-500586; 0906357073

ğŸ“§ Emailï¼šrigzinsungbum@gmail.com

ğŸ“ åœ°å€ï¼šNo. 322, Shenqing Rd., Shengang Dist., 
        Taichung City 429014, Taiwan (R.O.C.)

ğŸ•’ æœå‹™æ™‚é–“ï¼š
   é€±ä¸€è‡³é€±äº” 09:00~17:00
   é€±æœ« 10:00~15:00

æ­¡è¿æ‚¨éš¨æ™‚èˆ‡æˆ‘å€‘è¯ç¹«ï¼Œæˆ‘å€‘å°‡ç«­èª ç‚ºæ‚¨æœå‹™ã€‚`;
            
            showInfoModal('è¯ç¹«å®¢æœ', contactContent);
        }

        // === äº‹ä»¶ç›£è½å™¨ ===
        document.addEventListener('DOMContentLoaded', function() {
            // è¼‰å…¥æ”¶è—
            loadFavorites();

            // æª¢æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„èªè­‰ä»¤ç‰Œ
            const savedToken = localStorage.getItem('adminAuthToken');
            if (savedToken) {
                authToken = savedToken;
                // é€™è£¡å¯ä»¥åŠ å…¥ä»¤ç‰Œé©—è­‰é‚è¼¯
            }

            // ç®¡ç†å“¡ç™»å…¥è¡¨å–®
            document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.getElementById('adminUsername').value;
                const password = document.getElementById('adminPassword').value;
                const submitBtn = e.target.querySelector('button[type="submit"]');
                
                setLoading(submitBtn, true);
                showMessage('æ­£åœ¨ç™»å…¥...', 'info');
                
                try {
                    await adminLogin(username, password);
                    closeModal('adminLoginModal');
                    showMessage('ç®¡ç†å“¡ç™»å…¥æˆåŠŸï¼', 'success');
                    enterMode('edit');
                } catch (error) {
                    showMessage(`ç™»å…¥å¤±æ•—: ${error.message}`, 'error');
                } finally {
                    setLoading(submitBtn, false);
                }
            });

            // æœå°‹åŠŸèƒ½
            document.getElementById('searchInputEl').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                
                if (!searchTerm) {
                    renderDocuments(documentsData);
                    return;
                }
                
                const filteredDocs = documentsData.filter(doc =>
                    (doc.tibetanTitle && doc.tibetanTitle.toLowerCase().includes(searchTerm)) ||
                    (doc.chineseTitle && doc.chineseTitle.toLowerCase().includes(searchTerm)) ||
                    (doc.englishTitle && doc.englishTitle.toLowerCase().includes(searchTerm)) ||
                    (doc.author && doc.author.toLowerCase().includes(searchTerm)) ||
                    (doc.ContentTibetan && doc.ContentTibetan.toLowerCase().includes(searchTerm)) ||
                    (doc.ContentChinese && doc.ContentChinese.toLowerCase().includes(searchTerm)) ||
                    (doc.ContentEnglish && doc.ContentEnglish.toLowerCase().includes(searchTerm)) ||
                    (doc.tags && doc.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
                );
                
                renderDocuments(filteredDocs);
                document.getElementById('totalCountEl').textContent = filteredDocs.length;
                
                if (filteredDocs.length === 0) {
                    document.getElementById('documentsGridEl').innerHTML = `
                        <div style="text-align:center;padding:3rem;color:var(--text-light);opacity:0.8;grid-column: 1/-1;">
                            <h3 style="margin-bottom:1rem;">æœªæ‰¾åˆ°ç›¸é—œæ–‡ç»</h3>
                            <p>æ²’æœ‰æ‰¾åˆ°èˆ‡ "${searchTerm}" ç›¸é—œçš„æ–‡ç»</p>
                        </div>
                    `;
                }
            });

            // æª¢è¦–æ¨¡å¼æŒ‰éˆ•
            document.getElementById('gridViewBtn').addEventListener('click', function() {
                this.classList.add('active');
                document.getElementById('listViewBtn').classList.remove('active');
                document.getElementById('documentsGridEl').style.gridTemplateColumns = 'repeat(auto-fit, minmax(350px, 1fr))';
            });

            document.getElementById('listViewBtn').addEventListener('click', function() {
                this.classList.add('active');
                document.getElementById('gridViewBtn').classList.remove('active');
                document.getElementById('documentsGridEl').style.gridTemplateColumns = '1fr';
                showMessage('æ¸…å–®æª¢è¦–åŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
            });

            // éŒ¯èª¤å›å ±è¡¨å–®
            document.getElementById('reportErrorForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const reportData = {
                    docId: document.getElementById('errorReportDocId').value,
                    pageUrl: document.getElementById('errorReportPageUrl').value,
                    context: document.getElementById('errorReportContext').value,
                    description: document.getElementById('errorReportDescription').value,
                    userEmail: document.getElementById('errorReportEmail').value
                };

                if (!reportData.description.trim()) {
                    showMessage('è«‹å¡«å¯«å•é¡Œæè¿°ï¼', 'error');
                    return;
                }
                
                const submitBtn = e.target.querySelector('button[type="submit"]');
                setLoading(submitBtn, true);
                showMessage('æ­£åœ¨æäº¤å›å ±...', 'info');
                
                try {
                    const result = await submitErrorReport(reportData);
                    showMessage(result.message || 'æ„Ÿè¬æ‚¨çš„å›å ±ï¼æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„è¨Šæ¯ã€‚', 'success');
                    closeModal('reportErrorModal');
                } catch (error) {
                    showMessage(`æäº¤å›å ±å¤±æ•—: ${error.message}`, 'error');
                } finally {
                    setLoading(submitBtn, false);
                }
            });

            // æ¨¡æ…‹æ¡†èƒŒæ™¯é»æ“Šé—œé–‰
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal(this.id);
                    }
                });
            });

            // ESC éµé—œé–‰æ¨¡æ…‹æ¡†
            document.addEventListener('keydown', function(e) {
                if (e.key === "Escape") {
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        closeModal(modal.id);
                    });
                }
            });

            // åˆå§‹åŒ–å´é‚Šæ¬„ç‹€æ…‹
            if (window.innerWidth <= 768) {
                isLeftSidebarActive = false;
            } else {
                isLeftSidebarActive = true;
            }
            // åè½‰ç‹€æ…‹ç„¶å¾Œåˆ‡æ›ï¼Œé€™æ¨£å¯ä»¥æ­£ç¢ºè¨­ç½®åˆå§‹ç‹€æ…‹
            isLeftSidebarActive = !isLeftSidebarActive;
            toggleLeftSidebar();
            
            // é¡¯ç¤ºé¦–é 
            showModeSelectorScreen();
            updateNavControls();
        });

        // çª—å£å¤§å°æ”¹è®Šæ™‚çš„éŸ¿æ‡‰å¼è™•ç†
        window.addEventListener('resize', function() {
            // åœ¨å°å±å¹•ä¸Šè‡ªå‹•é—œé–‰å´é‚Šæ¬„
            if (window.innerWidth <= 768 && isLeftSidebarActive) {
                toggleLeftSidebar();
            }
        });
    </script>
</body>
</html>