<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰æ—ºè«¾å¸ƒå…¨é›†é–±è®€ç³»çµ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Tibetan:wght@300;400;500;600;700&family=Noto+Serif+TC:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warm-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --green-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);

            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
            --shadow-soft: 0 8px 32px rgba(31, 38, 135, 0.37);
            --shadow-hover: 0 15px 35px rgba(31, 38, 135, 0.5);

            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --text-light: rgba(255, 255, 255, 0.9);

            /* For Tibetan titles, using the already loaded Noto Sans Tibetan */
            --tibetan-title-font: 'Noto Sans Tibetan', 'Noto Serif TC', serif;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background: url('background_literature.jpg') no-repeat center center;
            background-size: cover;
            transition: background 0.8s ease;
        }
        .background-container.warm { background: var(--warm-gradient); }
        .background-container.cool { background: var(--accent-gradient); }
        .background-container.nature { background: var(--green-gradient); }
        .background-container.sunset { background: var(--secondary-gradient); }

        .background-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="20" cy="20" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="0.5" fill="rgba(255,255,255,0.05)"/><circle cx="40" cy="80" r="1.5" fill="rgba(255,255,255,0.08)"/><circle cx="60" cy="10" r="0.8" fill="rgba(255,255,255,0.06)"/><circle cx="10" cy="60" r="1.2" fill="rgba(255,255,255,0.09)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            animation: float 15s ease-in-out infinite;
        }
        @keyframes float { 0%, 100% { transform: translateX(0) translateY(0); } 25% { transform: translateX(-3px) translateY(-3px); } 50% { transform: translateX(3px) translateY(3px); } 75% { transform: translateX(-2px) translateY(2px); } }

        .glass { background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); box-shadow: var(--shadow-soft); }

        #modeSelectorScreen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; position: relative; z-index: 10; }
        .mode-selector-content {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border-radius: 32px;
            padding: 4rem 3rem;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-soft);
            transform: translateY(0);
            animation: fadeInUp 1s ease-out;
            max-width: 850px; /* Increased width for non-wrapping title */
            width: 90%;
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .main-title {
            font-family: 'Noto Serif TC', serif;
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #fff, #f8f9fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.02em;
            white-space: nowrap; /* Ensure title does not wrap */
        }
        .tibetan-subtitle { font-family: 'Noto Sans Tibetan', serif; font-size: 1.4rem; color: var(--text-light); margin-bottom: 1rem; opacity: 0.95; font-weight: 400; letter-spacing: 0.05em; }
        .english-subtitle { font-size: 1.1rem; color: var(--text-light); margin-bottom: 2.5rem; opacity: 0.8; font-style: italic; font-weight: 300; }
        .mode-buttons { display: flex; gap: 1.5rem; flex-wrap: wrap; justify-content: center; margin-bottom: 2rem; }
        .mode-button { padding: 1.2rem 2.8rem; font-size: 1.1rem; font-weight: 500; border: none; border-radius: 25px; cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; background: var(--glass-bg); color: white; border: 1px solid var(--glass-border); backdrop-filter: blur(10px); min-width: 180px; }
        .mode-button:hover { transform: translateY(-8px) scale(1.05); box-shadow: 0 20px 40px rgba(0,0,0,0.3); background: rgba(255,255,255,0.35); }
        .mode-button::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; }
        .mode-button:hover::before { left: 100%; }

        .theme-switcher { display: flex; gap: 0.8rem; justify-content: center; margin-top: 2rem; }
        .theme-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); cursor: pointer; transition: all 0.3s ease; position: relative; }
        .theme-btn.default { background: var(--primary-gradient); } .theme-btn.warm { background: var(--warm-gradient); } .theme-btn.cool { background: var(--accent-gradient); } .theme-btn.nature { background: var(--green-gradient); } .theme-btn.sunset { background: var(--secondary-gradient); }
        .theme-btn:hover { transform: scale(1.1); border-color: rgba(255,255,255,0.6); }
        .theme-btn.active { border-color: white; box-shadow: 0 0 20px rgba(255,255,255,0.4); }

        #appContainer { display: none; width: 100%; min-height: 100vh; opacity: 0; animation: fadeIn 0.6s ease-out forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        body.app-active #appContainer { display: flex; }

        .sidebar { width: 320px; background: var(--glass-bg); backdrop-filter: blur(25px); overflow-y: auto; position: fixed; height: 100vh; left: 0; top: 0; z-index: 100; border-right: 1px solid var(--glass-border); transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .sidebar-header { padding: 2.5rem 2rem; background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%); border-bottom: 1px solid var(--glass-border); text-align: center; }
        .sidebar-title { font-family: 'Noto Serif TC', serif; font-size: 1.4rem; font-weight: 600; margin-bottom: 0.5rem; color: white; letter-spacing: 0.02em; }
        .sidebar-subtitle { font-family: 'Noto Sans Tibetan', serif; font-size: 1rem; color: var(--text-light); opacity: 0.8; font-weight: 300; }
        .course-menu { padding: 1.5rem 0; }
        .course-category { margin-bottom: 1rem; }
        .category-header { padding: 1.2rem 2rem; background: linear-gradient(90deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%); color: white; font-weight: 600; font-size: 0.95rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease; border-left: 4px solid transparent; letter-spacing: 0.02em; }
        .category-header:hover { background: linear-gradient(90deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.1) 100%); border-left-color: rgba(255,255,255,0.6); transform: translateX(5px); }
        .category-toggle { font-size: 0.8rem; transition: transform 0.3s ease; }
        .category-header.collapsed .category-toggle { transform: rotate(-90deg); }
        .course-list { background: rgba(255,255,255,0.05); max-height: 500px; overflow-y: auto; transition: max-height 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .course-list.collapsed { max-height: 0; overflow: hidden; }
        .course-item { padding: 1rem 2rem 1rem 2.5rem; cursor: pointer; transition: all 0.3s ease; border-left: 3px solid transparent; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; color: var(--text-light); font-weight: 400; }
        .course-item .language-indicator { font-size: 0.75em; opacity: 0.7; margin-left: 8px; }
        .course-item:hover { background: rgba(255,255,255,0.1); border-left-color: rgba(255,255,255,0.8); transform: translateX(8px); color: white; }
        .course-item.active { background: rgba(255,255,255,0.15); border-left-color: white; font-weight: 500; color: white; }

        .main-content { flex: 1; margin-left: 320px; min-height: 100vh; position: relative; transition: margin-left 0.4s ease, padding-right 0.4s ease; }
        .main-content.no-left-sidebar { margin-left: 0; }
        .main-content.with-right-sidebar { padding-right: 320px; }

        .top-bar { background: var(--glass-bg); backdrop-filter: blur(25px); padding: 1.2rem 2.5rem; display: flex; justify-content: space-between; align-items: center; color: white; border-bottom: 1px solid var(--glass-border); position: sticky; top: 0; z-index: 50; }
        .breadcrumb { font-size: 0.9rem; opacity: 0.9; display: flex; align-items: center; gap: 0.8rem; font-weight: 400; }
        .user-section { display: flex; align-items: center; gap: 1.2rem; }
        .modern-btn { padding: 0.8rem 1.8rem; background: var(--glass-bg); border: 1px solid var(--glass-border); color: white; border-radius: 20px; cursor: pointer; font-weight: 500; transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); font-size: 0.9rem; backdrop-filter: blur(10px); position: relative; overflow: hidden; }
        .modern-btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; }
        .modern-btn:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modern-btn:hover::before { left: 100%; }

        .container { padding: 3rem 2.5rem; max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 4rem; color: white; }
        .header h1 { font-family: 'Noto Serif TC', serif; font-size: 3.8rem; font-weight: 700; margin-bottom: 1.5rem; background: linear-gradient(45deg, #fff, #f0f0f0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: 0.02em; line-height: 1.2; }
        .header p { font-size: 1.3rem; opacity: 0.9; margin-bottom: 2rem; font-style: italic; font-weight: 300; letter-spacing: 0.01em; }

        .search-section { max-width: 700px; margin: 0 auto 4rem; position: relative; }
        .search-container { position: relative; background: var(--glass-bg); backdrop-filter: blur(20px); border-radius: 25px; border: 1px solid var(--glass-border); overflow: hidden; transition: all 0.3s ease; }
        .search-container:focus-within { transform: translateY(-2px); box-shadow: 0 15px 35px rgba(0,0,0,0.2); border-color: rgba(255,255,255,0.4); }
        .search-input { width: 100%; padding: 1.5rem 1.8rem 1.5rem 4rem; border: none; font-size: 1.1rem; background: transparent; color: white; font-weight: 400; }
        .search-input::placeholder { color: rgba(255,255,255,0.7); } .search-input:focus { outline: none; }
        .search-icon { position: absolute; left: 1.5rem; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.8); font-size: 1.3rem; }

        .stats-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem; background: var(--glass-bg); backdrop-filter: blur(20px); padding: 1.5rem 2rem; border-radius: 20px; color: white; border: 1px solid var(--glass-border); }
        .view-controls { display: flex; gap: 0.8rem; }
        .view-btn { padding: 0.8rem 1.5rem; border: none; border-radius: 15px; background: rgba(255,255,255,0.1); color: white; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem; font-weight: 500; }
        .view-btn.active { background: rgba(255,255,255,0.3); box-shadow: 0 4px 15px rgba(0,0,0,0.1); transform: translateY(-1px); }

        .documents-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 2.5rem; margin-bottom: 3rem; }
        .document-card { background: var(--glass-bg); backdrop-filter: blur(25px); border-radius: 24px; padding: 2.5rem; border: 1px solid var(--glass-border); transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); position: relative; overflow: hidden; }
        .document-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #667eea, #764ba2); }
        .document-card:hover { transform: translateY(-12px) scale(1.02); box-shadow: 0 25px 50px rgba(0,0,0,0.25); border-color: rgba(255,255,255,0.3); }
        .document-title {
            font-family: var(--tibetan-title-font); /* Using Noto Sans Tibetan for professional look */
            font-size: 1.4rem; /* Slightly larger for title */
            font-weight: 600; /* Bolder */
            margin-bottom: 0.8rem; color: white; line-height: 1.6; letter-spacing: 0.02em;
        }
        .document-subtitle { font-family: 'Noto Serif TC', serif; font-size: 1.2rem; color: rgba(255,255,255,0.9); margin-bottom: 1.5rem; font-weight: 400; letter-spacing: 0.01em; }
        .document-meta { display: flex; flex-direction: column; gap: 0.8rem; margin-bottom: 2rem; font-size: 0.9rem; color: rgba(255,255,255,0.8); }
        .meta-item { display: flex; align-items: center; gap: 0.8rem; font-weight: 400; }
        .document-preview { font-family: 'Noto Sans Tibetan', serif; font-size: 1rem; line-height: 1.8; color: rgba(255,255,255,0.85); margin-bottom: 2rem; max-height: 120px; overflow: hidden; position: relative; background: rgba(255,255,255,0.05); padding: 1.2rem; border-radius: 12px; border-left: 3px solid rgba(255,255,255,0.3); }
        .document-actions { display: flex; gap: 1.2rem; justify-content: space-between; align-items: center; }
        .btn { padding: 1rem 2rem; border: none; border-radius: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); text-decoration: none; display: inline-flex; align-items: center; gap: 0.8rem; font-size: 0.95rem; position: relative; overflow: hidden; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 12px 35px rgba(102, 126, 234, 0.5); }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }

        .utility-sidebar { width: 320px; overflow-y: auto; position: fixed; height: 100vh; right: -320px; top: 0; z-index: 90; transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); padding: 0; background: var(--glass-bg); backdrop-filter: blur(25px); border-left: 1px solid var(--glass-border); display: flex; flex-direction: column; }
        .utility-sidebar.open { right: 0; }
        .utility-sidebar-header { padding: 1.5rem; text-align: center; color: white; font-weight: 600; border-bottom: 1px solid var(--glass-border); background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.1) 100%);}
        .utility-sidebar-content { padding: 1rem; }
        .utility-item { padding: 0.8rem 1rem; margin-bottom: 0.5rem; border-radius: 8px; color: var(--text-light); cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; gap: 0.8rem; }
        .utility-item:hover { background-color: rgba(255,255,255,0.1); color: white; }
        .utility-item-icon { font-size: 1.2em; }
        #favoritesListContainerEl { padding: 0.5rem; background: rgba(0,0,0,0.1); border-radius: 6px; margin-top: 0.5rem; }
        .favorite-item { padding: 0.5rem; color: var(--text-light); cursor: pointer; border-radius: 4px; }
        .favorite-item:hover { background-color: rgba(255,255,255,0.15); color: white; }


        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); } .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding-right: 0 !important; }
            .main-title { font-size: 2.8rem; white-space: normal; /* Allow wrap on small screens if needed */ }
            .header h1 { font-size: 2.5rem; }
            .documents-grid { grid-template-columns: 1fr; gap: 1.5rem; }
            .mode-buttons { flex-direction: column; width: 100%; } .mode-button { width: 100%; }
            .modal-content { max-width: 95vw; max-height: 90vh; width: 95vw; margin: 1rem auto; } /* Adjust modal for small screens */
            .modal-header { padding: 1rem 1.5rem; }
            .modal-body { padding: 1rem 1.5rem; }
            .language-switcher button { padding: 0.5rem 0.8rem; font-size: 0.8rem;}
        }
        .menu-toggle { display: none; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 8px; transition: background 0.3s ease; }
        @media (max-width: 768px) { .menu-toggle { display: block !important; } }

        .admin-only { display: none !important; } .reader-only { display: none !important; }
        body.edit-mode .admin-only { display: inline-flex !important; }
        body.read-mode .reader-only { display: block !important; }
        body.read-mode .utility-toggle-btn.reader-only { display: inline-flex !important; }
        body.read-mode .utility-sidebar.reader-only { display: flex !important; }
        body.read-mode .btn-secondary.reader-only { display: inline-flex !important; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }

        .modal-content {
            background: var(--glass-bg); backdrop-filter: blur(25px); border-radius: 24px;
            max-width: min(95vw, 1200px); width: min(95vw, 1200px);
            max-height: min(90vh, 800px);
            overflow: hidden; /* Parent hides overflow, body scrolls */
            position: relative; margin: auto;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4); border: 1px solid var(--glass-border);
            display: flex; flex-direction: column;
        }
        .modal-header {
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            color: white; padding: 1.2rem 2rem;
            z-index: 10; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--glass-border);
            flex-shrink: 0; /* Header does not shrink */
        }
        .modal-header h2 { /* For admin/form modals */
            font-family: 'Noto Serif TC', serif;
            font-size: 1.5rem;
            font-weight: 600;
            flex-grow: 1;
        }
         /* Specific styling for document modal titles for non-wrapping and ellipsis */
        #modalTitleEl {
            font-family: 'Noto Serif TC', serif;
            font-size: 1.4rem; /* Adjust as needed */
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80%; /* Give some space to close button */
        }
        #modalTitleTibetanEl {
            font-family: var(--tibetan-title-font);
            font-size: 1.2rem; /* Adjust as needed */
            font-weight: 500;
            opacity: 0.8;
            margin-top: 0.3rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80%;
        }
        .modal-body {
            padding: 1.5rem 2rem; color: white;
            overflow-y: auto; /* Body scrolls vertically */
            overflow-x: hidden; /* Body usually does not scroll horizontally */
            flex-grow: 1; /* Body takes remaining space */
        }
        .modal-body h3 { /* For subtitles within language content */
            color: white !important; font-size: 1.3em; margin-top: 15px; margin-bottom: 10px;
            border-left: 4px solid rgba(255,255,255,0.6); padding-left: 12px;
            font-family: 'Noto Serif TC', serif; white-space: normal;
        }
        .modal-body h3:first-child { margin-top: 0; }

        .close-btn { background: none; border: none; color: white; font-size: 2rem; cursor: pointer; opacity: 0.8; transition: opacity 0.3s ease; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .close-btn:hover { opacity: 1; background: rgba(255,255,255,0.1); }

        .text-content-base { font-family: 'Noto Serif TC', serif; line-height: 1.8; color: white; }
        .language-content { display: none; /* Initially hidden, JS controls visibility */ }
        .tibetan-text { font-family: 'Noto Sans Tibetan', serif; font-size: 1.1em; line-height: 2; margin-bottom: 1em; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; }
        .chinese-text { font-family: 'Noto Serif TC', serif; font-size: 1.05em; text-align: justify; margin-bottom: 1em; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; }
        .english-text { font-family: 'Inter', sans-serif; font-size: 1em; line-height: 1.7; text-align: justify; margin-bottom: 1em; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; }
        .colophon { font-style: italic; font-size: 0.9em; color: rgba(255,255,255,0.7); margin-top: 20px; border-top: 1px dashed rgba(255,255,255,0.3); padding-top: 15px; white-space: pre-wrap; }

        .language-switcher {
            padding: 0.8rem 1.5rem 0.8rem;
            text-align: center;
            border-bottom: 1px solid var(--glass-border);
            background: rgba(0,0,0,0.1);
        }
        .language-switcher button {
            padding: 0.6rem 1.2rem;
            margin: 0 0.3rem;
            border: 1px solid rgba(255,255,255,0.2);
            background-color: rgba(255,255,255,0.1);
            color: white;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s, transform 0.2s;
        }
        .language-switcher button:hover {
            background-color: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }
        .language-switcher button.active {
            background-color: rgba(255,255,255,0.3);
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }
        .language-separator {
             margin: 20px 0; border: 0; border-top: 1px dashed rgba(255,255,255,0.3); display: none;
        }


        .message { position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 15px; color: white; font-weight: 500; z-index: 1001; box-shadow: 0 8px 25px rgba(0,0,0,0.3); backdrop-filter: blur(10px); animation: slideInRight 0.3s ease; }
        .message.success { background: linear-gradient(135deg, #48bb78, #38a169); }
        .message.error { background: linear-gradient(135deg, #f56565, #e53e3e); }
        .message.info { background: linear-gradient(135deg, #4299e1, #3182ce); }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }

        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: white; }
        .form-control, .form-select, .form-textarea { width: 100%; padding: 0.8rem; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; font-size: 1rem; transition: all 0.3s ease; background: rgba(255,255,255,0.1); color: white; backdrop-filter: blur(10px); }
        .form-textarea { min-height: 150px; resize: vertical; font-family: 'Noto Sans Tibetan', serif; }
        .form-control:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: rgba(255,255,255,0.5); box-shadow: 0 0 0 3px rgba(255,255,255,0.1); }
        .form-control::placeholder, .form-textarea::placeholder { color: rgba(255,255,255,0.6); }
    </style>
</head>
<body>
    <div class="background-container" id="backgroundContainer"></div>

    <div id="modeSelectorScreen">
        <div class="mode-selector-content">
            <h1 class="main-title">æ‰æ—ºè«¾å¸ƒå…¨é›†é–±è®€ç³»çµ±</h1>
            <p class="tibetan-subtitle">à¼„à¼…à¼ à¼à½šà½ºà¼‹à½‘à½–à½„à¼‹à½“à½¼à½¢à¼‹à½–à½´à½ à½²à¼‹à½‚à½¦à½´à½„à¼‹à½ à½–à½´à½˜à¼‹à½€à¾³à½¼à½‚à¼‹à½¦à¾Ÿà½ºà½‚à½¦à¼</p>
            <p class="english-subtitle">Tsewang Norbu Complete Works Reading System</p>
            <div class="mode-buttons">
                <button class="mode-button" onclick="enterMode('read')">ğŸ“– é€²å…¥é–±è®€æ¨¡å¼</button>
                <button class="mode-button" onclick="enterMode('edit')">ğŸ” é€²å…¥ç·¨è¼¯æ¨¡å¼</button>
            </div>
            <div class="theme-switcher">
                <div class="theme-btn default active" onclick="changeTheme('default')" title="ç¶“å…¸æ¼¸è®Š"></div>
                <div class="theme-btn warm" onclick="changeTheme('warm')" title="æº«æš–æ¼¸è®Š"></div>
                <div class="theme-btn cool" onclick="changeTheme('cool')" title="æ¸…æ¶¼æ¼¸è®Š"></div>
                <div class="theme-btn nature" onclick="changeTheme('nature')" title="è‡ªç„¶æ¼¸è®Š"></div>
                <div class="theme-btn sunset" onclick="changeTheme('sunset')" title="å¤•é™½æ¼¸è®Š"></div>
            </div>
        </div>
    </div>

    <div id="appContainer">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title">èª²ç¨‹ç›®éŒ„</h2>
                <p class="sidebar-subtitle">à½¦à¾³à½¼à½–à¼‹à½šà½“à¼‹à½‚à¾±à½²à¼‹à½‘à½€à½¢à¼‹à½†à½‚</p>
            </div>
            <nav class="course-menu" id="courseMenuContainer"></nav>
        </aside>

        <main class="main-content" id="mainContentArea">
            <div class="top-bar">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="menu-toggle" id="leftSidebarToggle" onclick="toggleSidebar('sidebar')">â˜°</button>
                    <div class="breadcrumb" id="breadcrumbPath">
                        <span>ğŸ  é¦–é </span>
                        <span>></span>
                        <span id="currentDocCategory">è‡ªå‚³</span>
                        <span>></span>
                        <span id="currentDocCategory">åª½å««ç§˜å¯†æ¥­ä¹‹æ˜é»</span>
                    </div>
                </div>
                <div class="user-section" id="userSectionEl"></div>
            </div>

            <div class="container">
                <header class="header">
                    <h1>æ‰æ—ºè«¾å¸ƒå…¨é›†é–±è®€ç³»çµ±</h1>
                    <p>à½šà½ºà¼‹à½‘à½–à½„à¼‹à½“à½¼à½¢à¼‹à½–à½´à½ à½²à¼‹à½‚à½¦à½´à½„à¼‹à½ à½–à½´à½˜à¼‹à½€à¾³à½¼à½‚à¼‹à½¦à¾Ÿà½ºà½‚à½¦à¼ | Tsewang Norbu Complete Works Reading System</p>
                </header>

                <div class="search-section">
                    <div class="search-container">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" class="search-input" placeholder="æœå°‹æ–‡ç»æ¨™é¡Œã€å…§å®¹æˆ–ä½œè€…..." id="searchInputEl">
                    </div>
                </div>

                <div class="stats-bar">
                    <div class="view-controls">
                        <button class="view-btn active" id="gridViewBtn">ğŸ“‡ å¡ç‰‡æª¢è¦–</button>
                        <button class="view-btn" id="listViewBtn">ğŸ“‹ æ¸…å–®æª¢è¦–</button>
                    </div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">
                        ç¸½è¨ˆ <strong id="totalCountEl">0</strong> éƒ¨æ–‡ç»
                    </div>
                </div>

                <div class="documents-grid" id="documentsGridEl">
                    <!-- æ–‡ç»å¡ç‰‡å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </main>

        <aside class="utility-sidebar reader-only" id="utilitySidebarEl">
            <div class="utility-sidebar-header">
                <h3 class="utility-sidebar-title">å·¥å…·é¸å–®</h3>
            </div>
            <div class="utility-sidebar-content">
                <div class="utility-item" onclick="showFavorites()">
                    <span class="utility-item-icon"> â™¥ </span> å·²æ”¶è—æ–‡ç« 
                </div>
                <div id="favoritesListContainerEl" style="display:none;">
                    <p>æš«ç„¡æ”¶è—ã€‚</p>
                </div>
                <div class="utility-item" onclick="showUtilityModal('reportErrorModal', 'å›å ±éŒ¯å­—')">
                    <span class="utility-item-icon"> âœ‰ï¸ </span> å›å ±éŒ¯å­—
                </div>
                <div class="utility-item" onclick="showUtilityModal('donateModal', 'è­·æŒè´ŠåŠ©')">
                    <span class="utility-item-icon"> ğŸ’° </span> è­·æŒè´ŠåŠ©
                </div>
            </div>
        </aside>
    </div>

    <!-- æ–‡ç»æª¢è¦–æ¨¡æ…‹æ¡† -->
    <div class="modal" id="documentModalEl">
        <div class="modal-content">
            <div class="modal-header">
                <div style="width: calc(100% - 60px); display: flex; flex-direction: column;">
                    <h2 id="modalTitleEl">æ–‡ç»æ¨™é¡Œ</h2>
                    <div id="modalTitleTibetanEl" class="modal-title-tibetan">è—æ–‡æ¨™é¡Œå‰¯æ¨™</div>
                </div>
                <button class="close-btn" onclick="closeModal('documentModalEl')">Ã—</button>
            </div>
            <div class="language-switcher" id="languageSwitcherControls">
                <button onclick="showLanguage('bo')" data-lang="bo">è—æ–‡</button>
                <button onclick="showLanguage('zh')" data-lang="zh">ä¸­æ–‡</button>
                <button onclick="showLanguage('en')" data-lang="en">English</button>
                <button onclick="showLanguage('bo-zh')" data-lang="bo-zh">è—ä¸­å°ç…§</button>
                <!-- Add more combinations as needed, e.g., bo-en, zh-en -->
            </div>
            <div class="modal-body text-content-base" id="modalBodyEl">
                <div id="modalTibetanContentEl" class="language-content tibetan-text"></div>
                <hr class="language-separator">
                <div id="modalChineseContentEl" class="language-content chinese-text"></div>
                <hr class="language-separator">
                <div id="modalEnglishContentEl" class="language-content english-text"></div>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†å“¡ç™»å…¥æ¨¡æ…‹æ¡† -->
    <div class="modal" id="adminLoginModalEl">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2>ğŸ”’ ç®¡ç†å“¡ç™»å…¥</h2>
                <button class="close-btn" onclick="closeModal('adminLoginModalEl'); showModeSelectorScreen();">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="adminLoginFormEl">
                    <div class="form-group">
                        <label for="adminUsername">ç”¨æˆ¶å</label>
                        <input type="text" id="adminUsername" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="adminPassword">å¯†ç¢¼</label>
                        <input type="password" id="adminPassword" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">ç™»å…¥</button>
                </form>
            </div>
        </div>
    </div>

    <!-- æ–‡ç»è¡¨å–®æ¨¡æ…‹æ¡† (æ–°å¢/ç·¨è¼¯) -->
    <div class="modal" id="articleFormModalEl">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="articleFormModalTitleEl">ğŸ“ æ–°å¢/ç·¨è¼¯æ–‡ç»</h2>
                <button class="close-btn" onclick="closeModal('articleFormModalEl')">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="articleFormEl">
                    <input type="hidden" id="articleId">
                    <div class="form-group">
                        <label for="articleTibetanTitle">è—æ–‡æ¨™é¡Œ</label>
                        <input type="text" id="articleTibetanTitle" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="articleChineseTitle">ä¸­æ–‡æ¨™é¡Œ</label>
                        <input type="text" id="articleChineseTitle" class="form-control" required>
                    </div>
                     <div class="form-group">
                        <label for="articleEnglishTitle">è‹±æ–‡æ¨™é¡Œ (é¸å¡«)</label>
                        <input type="text" id="articleEnglishTitle" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="articleAuthor">ä½œè€…</label>
                        <input type="text" id="articleAuthor" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="articleCategory">åˆ†é¡</label>
                        <input type="text" id="articleCategory" class="form-control" placeholder="ä¾‹å¦‚ï¼šç¥ˆè«‹æ–‡ã€è‡ªå‚³" required>
                    </div>
                    <div class="form-group">
                        <label for="articleTags">æ¨™ç±¤ (é€—è™Ÿåˆ†éš”)</label>
                        <input type="text" id="articleTags" class="form-control" placeholder="ä¾‹å¦‚ï¼šé•·å£½, é‡‘å‰›çµ">
                    </div>
                    <div class="form-group">
                        <label for="articleContentTibetan">è—æ–‡å…§å®¹</label>
                        <textarea id="articleContentTibetan" class="form-textarea" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="articleContentChinese">ä¸­æ–‡å…§å®¹</label>
                        <textarea id="articleContentChinese" class="form-textarea" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="articleContentEnglish">è‹±æ–‡å…§å®¹ (é¸å¡«)</label>
                        <textarea id="articleContentEnglish" class="form-textarea"></textarea>
                    </div>
                    <div class="form-group">
                        <label>å¯æä¾›èªè¨€ (å‹¾é¸)</label>
                        <div>
                            <input type="checkbox" id="langBo" value="bo" checked> <label for="langBo" style="display:inline; margin-right:10px;">è—æ–‡</label>
                            <input type="checkbox" id="langZh" value="zh" checked> <label for="langZh" style="display:inline; margin-right:10px;">ä¸­æ–‡</label>
                            <input type="checkbox" id="langEn" value="en"> <label for="langEn" style="display:inline;">è‹±æ–‡</label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">å„²å­˜æ–‡ç»</button>
                </form>
            </div>
        </div>
    </div>

    <!-- å·¥å…·æ¨¡æ…‹æ¡† (å›å ±/è´ŠåŠ©ç­‰) -->
    <div class="modal" id="utilityModalEl">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="utilityModalTitleEl">å·¥å…·è¦–çª—</h2>
                <button class="close-btn" onclick="closeModal('utilityModalEl')">Ã—</button>
            </div>
            <div class="modal-body" id="utilityModalBodyEl">
                <!-- Content dynamically inserted by JS -->
            </div>
        </div>
    </div>

    <div id="messageAreaEl"></div>

    <script>
        // --- DATA (Sample) ---
        // IMPORTANT: Update this data structure and content
        let documentsData = [];
        const initialDocuments = [
            {
                id: 'mamo_secret',
                tibetanTitle: 'à½˜à¼‹à½˜à½¼à¼‹à½‚à½¦à½„à¼‹à½–à¼‹à½£à½¦à¼‹à½€à¾±à½²à¼‹à½à½²à½‚à¼‹à½£à½ºà¼',
                chineseTitle: 'åª½å««ç§˜å¯†æ¥­ä¹‹æ˜é»',
                englishTitle: 'Mamo Secret Activity Point',
                author: 'è“®èŠ±ç”Ÿå¤§å¸« (à½¦à¾³à½¼à½–à¼‹à½‘à½”à½¼à½“à¼‹à½”à½‘à¾¨à¼‹à½¦à½¾à¼‹à½–à¾·à½±à¼‹à½–)',
                category: 'è‡ªå‚³',
                tags: ['å¯†çºŒ', 'ç©ºè¡Œæ¯', 'å„€è»Œ'],
                meta: { words: '', pages: '', readTime: '' },
                ContentTibetan: `<p class="tibetan-text">à½‘à½”à½£à¼‹à½£à¾¡à½“à¼‹à½˜à½à½ à¼‹à½ à½‚à¾²à½¼à½ à½²à¼‹à½šà½¼à½‚à½¦à¼‹à½–à½…à½¦à¼‹à½£à¼ à¼à½¢à¾£à½˜à¼‹à½”à½¢à¼‹à½–à½à½´à½‘à¼‹à½‘à½ºà¼‹à½•à¾±à½‚à¼‹à½ à½šà½£à¼‹à½£à½¼à¼ à¼à½‘à½–à¾±à½²à½„à½¦à¼‹à½‘à½„à¼‹à½¡à½ºà¼‹à½¤à½ºà½¦à¼‹à½‘à½–à¾±à½ºà½¢à¼‹à½˜à½ºà½‘à¼‹à½”à½ à½²à¼ à¼à½˜à½à½ à¼‹à½ à½‚à¾²à½¼à¼‹à½‘à¾²à½´à½‚à¼‹à½…à½´à¼‹à½¢à¾©à¼‹à½–à½¢à¾’à¾±à½‘à¼‹à½€à¾±à½²à¼ à¼à½‚à½™à½¼à¼‹à½˜à½¼à¼‹à½¦à¾²à½²à½‘à¼‹à½”à¼‹à½–à½‘à½ºà¼‹à½ à½‚à¾²à½¼à½ à½²à¼‹à½à½´à½‚à½¦à¼ à¼à½‚à½“à½¦à¼‹à½£à½´à½‚à½¦à¼‹à½à½–à½¦à¼‹à½‘à½„à¼‹à½¤à½ºà½¦à¼‹à½¢à½–à¼‹à½€à¾±à½²à½¦à¼ à¼à½ à½‚à¾²à½¼à¼‹à½–à¼‹à½ à½‘à¾²à½ºà½“à¼‹à½˜à½›à½‘à¼‹à½¡à½´à½˜à¼‹à½†à½ºà½“à¼‹à½£à¼ à¼à½‚à½¦à½¼à½£à¼‹à½–à¼‹à½ à½‘à½ºà½–à½¦à¼‹à½¦à½¼à¼‹à½–à¾±à½²à½“à¼‹à½‚à¾±à½²à½¦à¼‹à½¢à¾³à½¼à½–à½¦à¼ à¼</p>`,
                ContentChinese: `<p class="chinese-text">å‘å…·å¾·ç©ºè¡Œæ¯åŠçœ·å±¬ï¼Œæ­æ•¬é ‚ç¦®ï¼<br>æ³•ç•Œèˆ‡æ™ºæ…§ç„¡äºŒèåˆä¸­ï¼Œå…­åå…«ç©ºè¡Œæ¯ä¹‹ä¸»å°Šï¼Œè¼ªè¿´å–„è¶£å¿ƒè¦ä¹‹æ‰€åœ¨ï¼Œä»¥å¯¦ç›¸æ–¹ä¾¿èˆ‡æ™ºæ…§ï¼Œå¼•å°çœ¾ç”Ÿä¹‹å¤§ä½›æ¯å‰ï¼Œç¥ˆè«‹åŠ æŒï¼</p>`,
                ContentEnglish: `<p class="english-text">To the glorious host of Dakinis and assembly, I respectfully prostrate!<br>In the indivisible union of expanse and wisdom, the chief of the sixty-eight Dakinis, the heart of samsara's blissful path, the great mother who guides beings with reality, method, and wisdom, I pray for your blessings!</p>`,
                availableLanguages: ['bo', 'zh', 'en']
            },
            {
                id: 'prayer1',
                tibetanTitle: ' à¼ˆ à½šà½ºà¼‹à½¦à¾’à¾²à½´à½–à¼‹à½¢à¾¡à½¼à¼‹à½¢à¾—à½ºà¼‹à½¢à¾’à¾±à¼‹à½˜à½‘à½´à½‘à¼‹à½€à¾±à½²à¼‹à½‚à½¦à½¼à½£à¼‹à½ à½‘à½ºà½–à½¦à¼‹à½˜à½²à¼‹à½¤à½²à½‚à½¦à¼‹à½‘à¾­à½„à½¦à¼‹à½˜à½ à½²à¼‹à½‘à½„à½¼à½¦à¼‹à½‚à¾²à½´à½–à¼‹à½…à½ºà½¦à¼‹à½–à¾±à¼‹à½–à¼‹à½–à½à½´à½‚à½¦à¼‹à½¦à½¼à¼ à¼',
                chineseTitle: 'å£½ä¿®é‡‘å‰›çµä¹‹ç¥ˆè«‹æ–‡ã€ˆä¸æ»…ç²¾ç²¹æˆå°±ã€‰',
                englishTitle: 'Prayer for Longevity Accomplishment of the Vajra Knot: "Indestructible Pure Siddhi"',
                author: 'ä»çæ‰æ—ºè«¾å¸ƒ',
                category: 'ç¥ˆè«‹æ–‡',
                tags: ['é•·å£½', 'é‡‘å‰›çµ', 'ç¥ˆè«‹'],
                meta: { words: '', pages: '', readTime: '' },
                ContentTibetan: `<p class="tibetan-text">à¼ˆ à½šà½ºà¼‹à½¦à¾’à¾²à½´à½–à¼‹à½¢à¾¡à½¼à¼‹à½¢à¾—à½ºà¼‹à½¢à¾’à¾±à¼‹à½˜à½‘à½´à½‘à¼‹à½€à¾±à½²à¼‹à½‚à½¦à½¼à½£à¼‹à½ à½‘à½ºà½–à½¦à¼‹à½˜à½²à¼‹à½¤à½²à½‚à½¦à¼‹à½‘à¾­à½„à½¦à¼‹à½˜à½ à½²à¼‹à½‘à½„à½¼à½¦à¼‹à½‚à¾²à½´à½–à¼‹à½…à½ºà½¦à¼‹à½–à¾±à¼‹à½–à¼‹à½–à½à½´à½‚à½¦à¼‹à½¦à½¼à¼ à¼<br>à½¨à½¼à½¾à¼‹à½¨à½±à¼‹à½§à½±à½´à¾ƒà¼‹à½§à¾²à½±à½²à½¿ à½˜à½²à¼‹à½¤à½²à½‚à¼‹à½‘à¾­à½„à½¦à¼‹à½˜à¼‹à½¢à¾Ÿà½‚à¼‹à½–à½¢à¾Ÿà½“à¼‹à½‚à½¡à½´à½„à¼‹à½‘à¾²à½´à½„à¼‹à½‚à½² à¼à½„à½¼à¼‹à½–à½¼à½¢à¼‹à½¢à½–à¼‹à½–à½à½´à½‚à½¦à¼‹à½–à½‘à½ºà¼‹à½†à½ºà½“à¼‹à½ à½à½¼à½¢à¼‹à½£à½¼à½¦à¼‹à½–à½¦à¾’à¾±à½´à½¢à¼ à¼à½¢à¾’à¾±à½£à¼‹à½–à¼‹à½¢à¾’à¾±à¼‹à½˜à½šà½¼à½ à½²à¼‹à½¦à¾¤à¾²à½´à½£à¼‹à½–à½à½²à¼‹à½ à½¼à½‘à¼‹à½‘à½”à½‚à¼‹à½˜à½ºà½‘à¼ à¼à½šà½ºà¼‹à½–à½‘à½‚à¼‹à½˜à½‚à½¼à½“à¼‹à½”à½¼à¼‹à½˜à½†à½¼à½‚à¼‹à½‘à½ºà½¢à¼‹à½‚à½¦à½¼à½£à¼‹à½–à¼‹à½ à½‘à½ºà½–à½¦à¼ à¼</p>`,
                ContentChinese: `<p class="chinese-text">å£½ä¿®é‡‘å‰›çµä¹‹ç¥ˆè«‹æ–‡ã€ˆä¸æ»…ç²¾ç²¹æˆå°±ã€‰<br>å—¡é˜¿å½å•¥<br>ä¸æ»…ç²¾ç²¹æ†å¸¸å …å›ºä¹‹ï¼Œé«”æ€§å®‰ä½å¤§æ¨‚è½‰è¼ªè€…ï¼Œ<br>å‹è€…æµ·æœƒåŒ–åŸºç„¡é‡å…‰ï¼Œè–å°ŠæŒå£½æ€™ä¸»èª ç¥ˆè«‹ã€‚</p><div class="colophon">å¦‚æ˜¯ç„¡é‡æ™ºå£½ä½›ä¹‹å£è¨£ï¼Œç«‹é¡Œæ›°ç„¡æ­»é‡‘å‰›çµä¹‹å‚³æ‰¿ç¥ˆè«‹æ–‡ä¸æ»…åœ“æˆä¹ƒä¾å¤é­¯æ¯”ä¸˜å¤šå‚‘çå·´ä»æ¬½è”£è²ç§‹é”å±¢å±¢ä»¥èªå‹¸è«‹æ•…ï¼Œä»çæ‰æ—ºè«¾å¸ƒæ–¼å¨çŒ›éµçŒ´å¹´ç¥è®Šæœˆä¹‹ä¸‹å¼¦åˆåä¸€åº§éƒ¨ä»½é–“ï¼Œæ–¼æ´›è·¯è¾²ç‰§å€äº¤ç•Œä¸­å¤®ï¼Œä¿®å®šä¹‹ç„¡æ­»å …å›ºèŒ…èŒ¨ä¸­æ‰€æ›¸ï¼Œå–„å“‰ï¼èŠ’å˜æœ—ï¼</div>`,
                ContentEnglish: `<p class="english-text">Prayer for Longevity Accomplishment of the Vajra Knot: "Indestructible Pure Siddhi"<br>OM AH HUM HRIH<br>Indestructible, pure, ever-stable, svastika essence, perfectly abiding, great bliss chakravartin,<br>Victorious ocean's four emanations, Amitabha, supreme lord of life, to you I pray.</p><div class="colophon">Thus, the oral instruction of Amitayus, titled "Deathless Vajra Knot Lineage Prayer: Indestructible Accomplishment," was written by Rigdzin Tsewang Norbu during a session on the eleventh day of the waning moon in the month of miracles, in the fierce Iron Monkey year, at the central border of the Loro nomadic area, in the deathless, firm hermitage of meditative practice, due to the repeated verbal requests of Shar Kachu Dorje Dzinpa Rinchen Jampel ChÃ¶dar. Sarva Mangalam!</div>`,
                availableLanguages: ['bo', 'zh', 'en']
            },
            // Add more documents here following the new structure...
            { id: 'prayer2', tibetanTitle: 'à¼ˆ à½¢à¾«à½¼à½‚à½¦à¼‹à½†à½ºà½“à¼‹à½‘à½€à½¼à½“à¼‹à½˜à½†à½¼à½‚à¼‹à½¦à¾¤à¾±à½²à¼‹à½ à½‘à½´à½¦à¼‹à½–à½¢à¾’à¾±à½´à½‘à¼‹à½”à½ à½²à¼‹à½‚à½¦à½¼à½£à¼‹à½ à½‘à½ºà½–à½¦à¼‹à½¢à¾’à¾±à½´à½“à¼‹à½à¾±à½ºà½¢à¼‹à½¡à½²à½‘à¼‹à½–à½à½²à½“à¼‹à½‚à½à½ºà½¢à¼‹à½¦à¾¦à¾±à½²à½“à¼‹à½à½ºà½¦à¼‹à½–à¾±à¼‹à½–à¼‹à½–à½à½´à½‚à½¦à¼‹à½¦à½¼à¼ à¼', chineseTitle: 'å¤§åœ“æ»¿ä¸‰å¯¶ç¸½é›†å‚³æ‰¿ç¥ˆè«‹æ—¥ä¿®è³œå¦‚æ„è—', englishTitle: 'Dzogchen Three Jewels General Embodiment Lineage Prayer Daily Practice: "Wish-Fulfilling Treasure Giver"', author: 'æ‰æ—ºè«¾å¸ƒ', category: 'ç¥ˆè«‹æ–‡', tags: ['å¤§åœ“æ»¿', 'ä¸‰å¯¶ç¸½é›†'], meta: {}, ContentTibetan: `<p class="tibetan-text">...</p>`, ContentChinese: `<p class="chinese-text">...</p>`, ContentEnglish: `<p class="english-text">...</p>`, availableLanguages: ['bo', 'zh'] },

        ];

        // --- DOM Elements ---
        const documentsGridEl = document.getElementById('documentsGridEl');
        const searchInputEl = document.getElementById('searchInputEl');
        const totalCountEl = document.getElementById('totalCountEl');
        const documentModalEl = document.getElementById('documentModalEl');
        const modalTitleEl = document.getElementById('modalTitleEl');
        const modalTitleTibetanEl = document.getElementById('modalTitleTibetanEl');
        const modalBodyEl = document.getElementById('modalBodyEl');
        const modalTibetanContentEl = document.getElementById('modalTibetanContentEl');
        const modalChineseContentEl = document.getElementById('modalChineseContentEl');
        const modalEnglishContentEl = document.getElementById('modalEnglishContentEl');
        const languageSwitcherControlsEl = document.getElementById('languageSwitcherControls');
        const languageSeparators = modalBodyEl.querySelectorAll('.language-separator');

        const adminLoginModalEl = document.getElementById('adminLoginModalEl');
        const adminLoginFormEl = document.getElementById('adminLoginFormEl');
        const userSectionEl = document.getElementById('userSectionEl');
        const messageAreaEl = document.getElementById('messageAreaEl');
        const articleFormModalEl = document.getElementById('articleFormModalEl');
        const articleFormEl = document.getElementById('articleFormEl');
        const articleFormModalTitleEl = document.getElementById('articleFormModalTitleEl');
        const courseMenuContainerEl = document.getElementById('courseMenuContainer');
        const utilitySidebarEl = document.getElementById('utilitySidebarEl');
        const favoritesListContainerEl = document.getElementById('favoritesListContainerEl');
        const utilityModalEl = document.getElementById('utilityModalEl');
        const utilityModalTitleEl = document.getElementById('utilityModalTitleEl');
        const utilityModalBodyEl = document.getElementById('utilityModalBodyEl');
        const modeSelectorScreenEl = document.getElementById('modeSelectorScreen');
        const appContainerEl = document.getElementById('appContainer');
        const mainContentAreaEl = document.getElementById('mainContentArea');
        const leftSidebarEl = document.getElementById('sidebar');
        const backgroundContainerEl = document.getElementById('backgroundContainer');
        const breadcrumbPathEl = document.getElementById('breadcrumbPath');
        const currentDocCategoryEl = document.getElementById('currentDocCategory');
        const currentDocTitleEl = document.getElementById('currentDocTitle');

        // --- State Variables ---
        let currentView = 'grid';
        let isAdminLoggedIn = false;
        let currentOpenDocId = null;
        let currentMode = '';
        let guestFavorites = [];

        // --- Theme Switcher ---
        function changeTheme(themeName) {
            backgroundContainerEl.className = 'background-container';
            if (themeName !== 'default') backgroundContainerEl.classList.add(themeName);
            document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.theme-btn.${themeName}`).classList.add('active');
        }

        // --- Mode Management ---
        function enterMode(mode) {
            currentMode = mode;
            modeSelectorScreenEl.style.display = 'none';
            document.body.classList.add('app-active');
            document.body.classList.remove('read-mode', 'edit-mode');
            document.body.classList.add(mode + '-mode');
            if (mode === 'edit') {
                adminLoginModalEl.classList.add('active');
            } else {
                isAdminLoggedIn = false;
                setupReadModeUI();
                loadInitialContent();
            }
        }
        function showModeSelectorScreen() {
            modeSelectorScreenEl.style.display = 'flex';
            document.body.classList.remove('app-active', 'read-mode', 'edit-mode');
            if (currentMode === 'edit' && isAdminLoggedIn) adminLogout(false);
            currentMode = '';
            updateUserSectionUI();
        }
        function setupReadModeUI() {
            document.body.classList.remove('edit-mode'); document.body.classList.add('read-mode');
            mainContentAreaEl.classList.remove('no-left-sidebar');
            if (utilitySidebarEl.classList.contains('open')) mainContentAreaEl.classList.add('with-right-sidebar');
            else mainContentAreaEl.classList.remove('with-right-sidebar');
            leftSidebarEl.style.transform = 'translateX(0)';
            updateUserSectionUI();
        }
        function setupEditModeUI() {
            document.body.classList.remove('read-mode'); document.body.classList.add('edit-mode');
            mainContentAreaEl.classList.remove('with-right-sidebar', 'no-left-sidebar');
            leftSidebarEl.style.transform = 'translateX(0)';
            updateUserSectionUI();
        }

        // --- Data Management ---
        function updateDocumentMeta(doc) {
            const plainTibetan = (doc.ContentTibetan || "").replace(/<[^>]+>/g, "");
            const plainChinese = (doc.ContentChinese || "").replace(/<[^>]+>/g, "");
            const tibetanSyllables = plainTibetan.split(/[à¼‹\s]+/).filter(s => s.trim().length > 0).length;
            const chineseChars = plainChinese.replace(/[^\u4e00-\u9fa5]/g, "").length;
            doc.meta.words = `è— ${tibetanSyllables} éŸ³ç¯€ | ä¸­ ${chineseChars} å­—`;
            const readTimeMinutes = Math.ceil((chineseChars / 250) + (tibetanSyllables / 150));
            doc.meta.readTime = `é–±è®€ç´„ ${readTimeMinutes} åˆ†é˜`;
            doc.meta.pages = `${Math.ceil(readTimeMinutes / 5)} é  (ä¼°ç®—)`;
            doc.preview = plainTibetan.substring(0, 80) + (plainTibetan.length > 80 ? '...' : '');
        }
        function processAllDocumentMeta() { documentsData.forEach(doc => { if (!doc.meta) doc.meta = {}; updateDocumentMeta(doc); }); }
        function loadDocumentsData() { documentsData = JSON.parse(JSON.stringify(initialDocuments)); processAllDocumentMeta(); }

        // --- UI Rendering ---
        function updateBreadcrumb(category, title) {
            currentDocCategoryEl.textContent = category || 'æœªçŸ¥åˆ†é¡';
            currentDocTitleEl.textContent = title || 'æœªé¸æ–‡ç»';
        }

        function renderDocuments(filteredDocuments) {
            documentsGridEl.innerHTML = '';
            const documentsToRender = filteredDocuments || documentsData;
            totalCountEl.textContent = documentsToRender.length;
            documentsToRender.forEach(doc => {
                const card = document.createElement('div');
                card.className = 'document-card';
                let actionButtonsHTML = '';
                if (currentMode === 'edit' && isAdminLoggedIn) {
                    actionButtonsHTML = `<button class="btn btn-secondary admin-only" onclick="openArticleFormModal('${doc.id}')">âœï¸ ç·¨è¼¯</button>`;
                } else if (currentMode === 'read') {
                    const isFavorited = guestFavorites.includes(doc.id);
                    actionButtonsHTML = `<button class="btn btn-secondary reader-only" onclick="toggleFavorite('${doc.id}', this)">${isFavorited ? 'â™¥ å·²æ”¶è—' : 'â™¡ åŠ å…¥æ”¶è—'}</button>`;
                }
                card.innerHTML = `
                    <h3 class="document-title">${doc.tibetanTitle.split('à¼')[0]}</h3>
                    <div class="document-subtitle">${doc.chineseTitle}</div>
                    <div class="document-meta">
                        <div class="meta-item"><span>â™›</span><span>${doc.author}</span></div>
                        <div class="meta-item"><span>ğŸ“„</span><span>${doc.meta.words}</span></div>
                        <div class="meta-item"><span>ğŸ“„</span><span>${doc.meta.pages}</span></div>
                        <div class="meta-item"><span>âŒ›</span><span>${doc.meta.readTime}</span></div>
                        ${doc.tags && doc.tags.length > 0 ? `<div class="meta-item"><span>ğŸ·ï¸</span><span>${doc.tags.join(', ')}</span></div>` : ''}
                    </div>
                    <div class="document-preview">${doc.preview}</div>
                    <div class="document-actions">
                        <button class="btn btn-primary" onclick="openDocumentModal('${doc.id}')">ğŸ“– é–±è®€å…¨æ–‡</button>
                        ${actionButtonsHTML}
                    </div>
                `;
                documentsGridEl.appendChild(card);
            });
        }

        // --- Modal Document Viewer ---
        function openDocumentModal(docId) {
            const doc = documentsData.find(d => d.id === docId);
            if (!doc) return;
            currentOpenDocId = docId;
            modalTitleEl.textContent = doc.chineseTitle;
            modalTitleTibetanEl.textContent = doc.tibetanTitle.split('à¼')[0];

            modalTibetanContentEl.innerHTML = doc.ContentTibetan ? `<h3>è—æ–‡åŸæ–‡</h3>${doc.ContentTibetan}` : '';
            modalChineseContentEl.innerHTML = doc.ContentChinese ? `<h3>ä¸­æ–‡ç¿»è­¯</h3>${doc.ContentChinese}` : '';
            modalEnglishContentEl.innerHTML = doc.ContentEnglish ? `<h3>English Translation</h3>${doc.ContentEnglish}` : '';
            
            updateLanguageSwitcher(doc.availableLanguages || []);
            showLanguage('bo-zh'); // Default to Tibetan-Chinese view or first available
            
            documentModalEl.classList.add('active');
            updateBreadcrumb(doc.category, doc.chineseTitle);
            setActiveSidebarItem(docId);
        }

        function updateLanguageSwitcher(availableLangs) {
            const buttons = languageSwitcherControlsEl.querySelectorAll('button[data-lang]');
            buttons.forEach(btn => {
                const lang = btn.dataset.lang;
                if (lang.includes('-')) { // For combined views like 'bo-zh'
                    const [lang1, lang2] = lang.split('-');
                    btn.style.display = (availableLangs.includes(lang1) && availableLangs.includes(lang2)) ? 'inline-block' : 'none';
                } else { // For single language views
                    btn.style.display = availableLangs.includes(lang) ? 'inline-block' : 'none';
                }
            });
        }

        function showLanguage(langCode) {
            modalTibetanContentEl.style.display = 'none';
            modalChineseContentEl.style.display = 'none';
            modalEnglishContentEl.style.display = 'none';
            languageSeparators.forEach(sep => sep.style.display = 'none');

            const doc = documentsData.find(d => d.id === currentOpenDocId);
            if (!doc) return;

            let activeSeparatorIndex = 0;
            const hasTibetan = doc.availableLanguages.includes('bo') && modalTibetanContentEl.innerHTML.trim() !== '';
            const hasChinese = doc.availableLanguages.includes('zh') && modalChineseContentEl.innerHTML.trim() !== '';
            const hasEnglish = doc.availableLanguages.includes('en') && modalEnglishContentEl.innerHTML.trim() !== '';

            if (langCode === 'bo' && hasTibetan) {
                modalTibetanContentEl.style.display = 'block';
            } else if (langCode === 'zh' && hasChinese) {
                modalChineseContentEl.style.display = 'block';
            } else if (langCode === 'en' && hasEnglish) {
                modalEnglishContentEl.style.display = 'block';
            } else if (langCode === 'bo-zh') {
                if (hasTibetan) modalTibetanContentEl.style.display = 'block';
                if (hasTibetan && hasChinese && languageSeparators[activeSeparatorIndex]) {
                    languageSeparators[activeSeparatorIndex].style.display = 'block';
                    activeSeparatorIndex++;
                }
                if (hasChinese) modalChineseContentEl.style.display = 'block';
            }
            // Add other combinations like 'bo-en', 'zh-en', 'bo-zh-en' if needed
            // Example for bo-en:
            // else if (langCode === 'bo-en') {
            //     if (hasTibetan) modalTibetanContentEl.style.display = 'block';
            //     if (hasTibetan && hasEnglish && languageSeparators[activeSeparatorIndex]) {
            //         languageSeparators[activeSeparatorIndex].style.display = 'block';
            //         activeSeparatorIndex++;
            //     }
            //     if (hasEnglish) modalEnglishContentEl.style.display = 'block';
            // }

            // Update active button style
            languageSwitcherControlsEl.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            const activeButton = languageSwitcherControlsEl.querySelector(`button[data-lang="${langCode}"]`);
            if (activeButton) activeButton.classList.add('active');
        }


        function closeModal(modalId) {
            const modalToClose = document.getElementById(modalId);
            if (modalToClose) modalToClose.classList.remove('active');
            if (modalId === 'documentModalEl') currentOpenDocId = null;
            if (modalId === 'articleFormModalEl') { articleFormEl.reset(); document.getElementById('articleId').value = ''; }
        }

        // --- Admin & User Section ---
        adminLoginFormEl.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            if (username === 'admin' && password === 'password123') { // Replace with secure auth
                isAdminLoggedIn = true; closeModal('adminLoginModalEl');
                showMessage('ç®¡ç†å“¡ç™»å…¥æˆåŠŸï¼', 'success');
                setupEditModeUI(); loadInitialContent();
            } else { showMessage('ç”¨æˆ¶åæˆ–å¯†ç¢¼éŒ¯èª¤ã€‚', 'error'); }
        });
        function adminLogout(switchToReadMode = true) {
            isAdminLoggedIn = false;
            if (switchToReadMode) {
                currentMode = 'read'; setupReadModeUI(); loadInitialContent();
                showMessage('ç®¡ç†å“¡å·²ç™»å‡ºã€‚å·²åˆ‡æ›è‡³é–±è®€æ¨¡å¼ã€‚', 'info');
            } else { updateUserSectionUI(); }
        }
        function updateUserSectionUI() {
            userSectionEl.innerHTML = '';
            if (currentMode === 'edit' && isAdminLoggedIn) {
                userSectionEl.innerHTML = `
                    <button class="modern-btn admin-only" onclick="openArticleFormModal()">âœ¨æ–°å¢æ–‡ç»</button>
                    <div style="color:white; display:flex; align-items:center; gap:0.5rem;" class="admin-only"><span>ç®¡ç†å“¡</span><div style="width:24px; height:24px; background:var(--accent-gradient); border-radius:50%; text-align:center; line-height:24px; font-weight:bold;">A</div></div>
                    <button class="modern-btn admin-only" onclick="adminLogout()">ç™»å‡ºç®¡ç†</button>`;
            } else if (currentMode === 'read') {
                userSectionEl.innerHTML = `<button class="modern-btn reader-only utility-toggle-btn" onclick="toggleSidebar('utilitySidebarEl')">â™¥æ”¶è—</button>`;
            }
            if (currentMode) {
                const backButton = document.createElement('button');
                backButton.className = 'modern-btn'; backButton.textContent = 'è¿”å›æ¨¡å¼é¸æ“‡';
                backButton.onclick = showModeSelectorScreen;
                userSectionEl.appendChild(backButton);
            }
        }
        function showMessage(msg, type = 'info') {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`; messageEl.textContent = msg;
            messageAreaEl.appendChild(messageEl);
            setTimeout(() => { messageEl.remove(); }, 3000);
        }

        // --- Sidebar Rendering ---
        function renderSidebar() {
            courseMenuContainerEl.innerHTML = '';
            const categories = {};
            const categoryOrder = ['å‚³è¨˜', 'è‡ªå‚³', 'é“æ­Œé›†', 'ä¿¡ä»¶', 'ç¥ˆè«‹æ–‡'];
            const categoryIcons = { 'å‚³è¨˜': 'ğŸ“š', 'è‡ªå‚³': 'ğŸ§˜', 'é“æ­Œé›†': 'ğŸ¶', 'ä¿¡ä»¶': 'ğŸ“¬', 'ç¥ˆè«‹æ–‡': 'ğŸ™' };
            documentsData.forEach(doc => { if (!categories[doc.category]) categories[doc.category] = []; categories[doc.category].push(doc); });
            const sortedCategoryNames = [...new Set([...categoryOrder, ...Object.keys(categories)])];

            sortedCategoryNames.forEach(categoryName => {
                if (!categories[categoryName] || categories[categoryName].length === 0) return;
                const categoryDocs = categories[categoryName];
                const categoryDiv = document.createElement('div'); categoryDiv.className = 'course-category';
                const header = document.createElement('div'); header.className = 'category-header collapsed';
                header.onclick = function() { toggleCategory(this); };
                header.innerHTML = `<span>${categoryIcons[categoryName] || 'ğŸ“–'} ${categoryName}</span><span class="category-toggle">â–¼</span>`;
                const list = document.createElement('div'); list.className = 'course-list collapsed';
                categoryDocs.forEach(doc => {
                    const item = document.createElement('div'); item.className = 'course-item'; item.dataset.docId = doc.id;
                    let displayTitle = doc.chineseTitle.length < 25 ? doc.chineseTitle : doc.tibetanTitle.split('à¼')[0];
                    if (displayTitle.length > 22) displayTitle = displayTitle.substring(0,20) + "...";
                    
                    let langIndicator = '';
                    if (doc.availableLanguages && doc.availableLanguages.length > 0) {
                        langIndicator = `<span class="language-indicator">[${doc.availableLanguages.join('/')}]</span>`;
                    }

                    item.innerHTML = `<span>${displayTitle} ${langIndicator}</span><span class="course-status pending" style="font-size:0.8em; opacity:0.7;">æœªè®€</span>`;
                    item.addEventListener('click', function() { openDocumentModal(doc.id); });
                    list.appendChild(item);
                });
                categoryDiv.appendChild(header); categoryDiv.appendChild(list); courseMenuContainerEl.appendChild(categoryDiv);
            });
            if (currentOpenDocId) setActiveSidebarItem(currentOpenDocId);
            else if (documentsData.length > 0) setActiveSidebarItem(documentsData[0].id);
        }
        function setActiveSidebarItem(docId) {
            document.querySelectorAll('.course-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.docId === docId) {
                    item.classList.add('active');
                    const categoryList = item.closest('.course-list');
                    if (categoryList && categoryList.classList.contains('collapsed')) {
                        const categoryHeader = categoryList.previousElementSibling;
                        if (categoryHeader) toggleCategory(categoryHeader);
                    }
                }
            });
        }
        window.toggleCategory = function(headerElement) {
            headerElement.classList.toggle('collapsed');
            headerElement.nextElementSibling.classList.toggle('collapsed');
        }
        window.toggleSidebar = function(sidebarId) {
            const sidebarToToggle = document.getElementById(sidebarId);
            sidebarToToggle.classList.toggle('open');
            if (sidebarId === 'sidebar') {
                mainContentAreaEl.classList.toggle('no-left-sidebar', !sidebarToToggle.classList.contains('open'));
                if (window.innerWidth <= 768) sidebarToToggle.style.transform = sidebarToToggle.classList.contains('open') ? 'translateX(0)' : 'translateX(-100%)';
            } else if (sidebarId === 'utilitySidebarEl') {
                mainContentAreaEl.classList.toggle('with-right-sidebar', sidebarToToggle.classList.contains('open'));
            }
        }

        // --- Search Function ---
        searchInputEl.addEventListener('input', function() {
            const searchTerm = searchInputEl.value.toLowerCase();
            const filtered = documentsData.filter(doc =>
                (doc.tibetanTitle && doc.tibetanTitle.toLowerCase().includes(searchTerm)) ||
                (doc.chineseTitle && doc.chineseTitle.toLowerCase().includes(searchTerm)) ||
                (doc.englishTitle && doc.englishTitle.toLowerCase().includes(searchTerm)) ||
                (doc.author && doc.author.toLowerCase().includes(searchTerm)) ||
                (doc.tags && doc.tags.some(tag => tag.toLowerCase().includes(searchTerm))) ||
                (doc.ContentTibetan && doc.ContentTibetan.toLowerCase().includes(searchTerm)) ||
                (doc.ContentChinese && doc.ContentChinese.toLowerCase().includes(searchTerm)) ||
                (doc.ContentEnglish && doc.ContentEnglish.toLowerCase().includes(searchTerm))
            );
            renderDocuments(filtered);
        });

        // --- View Mode (Grid/List) ---
        document.getElementById('gridViewBtn').addEventListener('click', () => { currentView = 'grid'; document.getElementById('gridViewBtn').classList.add('active'); document.getElementById('listViewBtn').classList.remove('active'); documentsGridEl.style.gridTemplateColumns = 'repeat(auto-fit, minmax(380px, 1fr))';});
        document.getElementById('listViewBtn').addEventListener('click', () => { currentView = 'list'; document.getElementById('listViewBtn').classList.add('active'); document.getElementById('gridViewBtn').classList.remove('active'); documentsGridEl.style.gridTemplateColumns = '1fr';});

        // --- Favorites ---
        function toggleFavorite(docId, buttonElement) { /* ... (existing logic) ... */ }
        function showFavorites() { /* ... (existing logic) ... */ }
        function renderFavoritesList() { /* ... (existing logic) ... */ }

        // --- Utility Modals (Report Error / Donate) ---
        function showUtilityModal(modalType, title) { /* ... (existing logic) ... */ }

        // --- Article Form (Add/Edit) ---
        function openArticleFormModal(docIdToEdit = null) {
            articleFormEl.reset(); document.getElementById('articleId').value = '';
            if (docIdToEdit) {
                const doc = documentsData.find(d => d.id === docIdToEdit);
                if (doc) {
                    articleFormModalTitleEl.textContent = 'âœ’ï¸ç·¨è¼¯æ–‡ç»';
                    document.getElementById('articleId').value = doc.id;
                    document.getElementById('articleTibetanTitle').value = doc.tibetanTitle;
                    document.getElementById('articleChineseTitle').value = doc.chineseTitle;
                    document.getElementById('articleEnglishTitle').value = doc.englishTitle || '';
                    document.getElementById('articleAuthor').value = doc.author;
                    document.getElementById('articleCategory').value = doc.category;
                    document.getElementById('articleTags').value = doc.tags ? doc.tags.join(', ') : '';
                    document.getElementById('articleContentTibetan').value = (doc.ContentTibetan || "").replace(/<p class="tibetan-text"[^>]*>/gi, '').replace(/<\/p>/gi, '').replace(/<br\s*\/?>/gi, '\n').trim();
                    document.getElementById('articleContentChinese').value = (doc.ContentChinese || "").replace(/<p class="chinese-text"[^>]*>/gi, '').replace(/<\/p>/gi, '').replace(/<div class="colophon"[^>]*>/gi, '\n<div class="colophon">\n').replace(/<\/div>/gi, '\n</div>\n').replace(/<br\s*\/?>/gi, '\n').trim();
                    document.getElementById('articleContentEnglish').value = (doc.ContentEnglish || "").replace(/<p class="english-text"[^>]*>/gi, '').replace(/<\/p>/gi, '').replace(/<br\s*\/?>/gi, '\n').trim();
                    (doc.availableLanguages || []).forEach(lang => {
                        const checkbox = document.getElementById(`lang${lang.charAt(0).toUpperCase() + lang.slice(1).toLowerCase()}`); // e.g. langBo
                        if(checkbox) checkbox.checked = true;
                    });
                } else { showMessage('æ‰¾ä¸åˆ°è¦ç·¨è¼¯çš„æ–‡ç»ã€‚', 'error'); return; }
            } else { articleFormModalTitleEl.textContent = 'ğŸ“ æ–°å¢æ–‡ç»'; }
            articleFormModalEl.classList.add('active');
        }
        articleFormEl.addEventListener('submit', function(e) {
            e.preventDefault();
            // Add actual save logic here or simulate
            showMessage('æ–‡ç»å„²å­˜åŠŸèƒ½åœ¨æ­¤æ¼”ç¤ºç‰ˆæœ¬ä¸­å·²æ¨¡æ“¬å®Œæˆï¼', 'success');
            closeModal('articleFormModalEl');
        });


        // --- Initialization ---
        function loadInitialContent() {
            loadDocumentsData(); renderSidebar(); renderDocuments();
            if (documentsData.length > 0) {
                const initialDocIdToDisplay = currentOpenDocId || (documentsData.find(d => d.id === 'mamo_secret') ? 'mamo_secret' : documentsData[0].id);
                const initialDoc = documentsData.find(d => d.id === initialDocIdToDisplay);
                if (initialDoc) { updateBreadcrumb(initialDoc.category, initialDoc.chineseTitle); setActiveSidebarItem(initialDoc.id); }
                else if (documentsData.length > 0) { updateBreadcrumb(documentsData[0].category, documentsData[0].chineseTitle); setActiveSidebarItem(documentsData[0].id); }
                else { updateBreadcrumb('N/A', 'ç„¡æ–‡ç»'); }
            } else { updateBreadcrumb('N/A', 'ç„¡æ–‡ç»'); }
        }

        // --- Global Functions on window object ---
        window.enterMode = enterMode; window.showModeSelectorScreen = showModeSelectorScreen;
        window.changeTheme = changeTheme; window.openDocumentModal = openDocumentModal;
        window.closeModal = closeModal; window.toggleFavorite = toggleFavorite;
        window.showFavorites = showFavorites; window.showUtilityModal = showUtilityModal;
        window.openArticleFormModal = openArticleFormModal; window.adminLogout = adminLogout;
        window.showLanguage = showLanguage; // Expose showLanguage globally

        // --- Initial Call & Event Listeners ---
        const mainTitleElementForAnimation = document.querySelector('.main-title');
        if (mainTitleElementForAnimation) {
            const typingAnimationName = 'typing';
            mainTitleElementForAnimation.addEventListener('animationend', function(event) {
                if (event.animationName === typingAnimationName) {
                    // mainTitleElementForAnimation.style.whiteSpace = 'normal'; // Title should not wrap as per request
                    mainTitleElementForAnimation.style.width = 'auto';
                    mainTitleElementForAnimation.style.borderRight = 'none';
                }
            });
        }
        showModeSelectorScreen(); // Start with mode selection

        document.addEventListener('DOMContentLoaded', function() {
            // Mouse follow effect for cards
            document.addEventListener('mousemove', function(e) {
                const cards = document.querySelectorAll('.document-card');
                cards.forEach(card => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left; const y = e.clientY - rect.top;
                    if (x >= 0 && x <= rect.width && y >= 0 && y <= rect.height) {
                        card.style.setProperty('--mouse-x', x + 'px');
                        card.style.setProperty('--mouse-y', y + 'px');
                    }
                });
            });
        });
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') { const activeModal = document.querySelector('.modal.active'); if (activeModal) activeModal.classList.remove('active'); }
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); searchInputEl.focus(); }
        });
        document.documentElement.style.scrollBehavior = 'smooth';

        // Dynamically added styles for animations (ensure it's appended once)
        if (!document.getElementById('dynamic-animation-styles')) {
            const dynamicStyle = document.createElement('style');
            dynamicStyle.id = 'dynamic-animation-styles';
            dynamicStyle.textContent = `
                .document-card { animation: cardSlideIn 0.6s ease-out forwards; opacity: 0; transform: translateY(30px); }
                .document-card:nth-child(1) { animation-delay: 0.1s; } .document-card:nth-child(2) { animation-delay: 0.2s; }
                .document-card:nth-child(3) { animation-delay: 0.3s; } .document-card:nth-child(4) { animation-delay: 0.4s; }
                .document-card:nth-child(5) { animation-delay: 0.5s; } .document-card:nth-child(6) { animation-delay: 0.6s; }
                @keyframes cardSlideIn { to { opacity: 1; transform: translateY(0); } }
                .document-card::after { content: ''; position: absolute; top: var(--mouse-y, 50%); left: var(--mouse-x, 50%); width: 100px; height: 100px; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); border-radius: 50%; transform: translate(-50%, -50%); opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
                .document-card:hover::after { opacity: 1; }
                .search-container:focus-within::before { content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px; background: linear-gradient(45deg, #667eea, #764ba2, #667eea); border-radius: 27px; z-index: -1; animation: searchGlow 2s linear infinite; background-size: 200% 200%; } /* Added background-size for better glow */
                @keyframes searchGlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
                .btn::before, .mode-button::before, .modern-btn::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%; background: rgba(255,255,255,0.3); transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s; pointer-events: none; /* Prevent ::before from blocking clicks */ }
                .btn:active::before, .mode-button:active::before, .modern-btn:active::before { width: 300px; height: 300px; }
                .course-item:hover { box-shadow: 0 0 20px rgba(255,255,255,0.1); }
                .modal.active .modal-content { animation: modalBounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
                @keyframes modalBounceIn { 0% { opacity: 0; transform: scale(0.3) translateY(-100px); } 50% { opacity: 1; transform: scale(1.05) translateY(0); } 70% { transform: scale(0.9); } 100% { transform: scale(1); } }
                .theme-btn::before { content: ''; position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px; border-radius: 50%; background: inherit; opacity: 0; transform: scale(0.8); transition: all 0.3s ease; z-index: -1; }
                .theme-btn:hover::before { opacity: 0.3; transform: scale(1); }
                .main-title { /* Ensure this matches the style block in head for animation */
                    overflow: hidden; border-right: 2px solid rgba(255,255,255,0.8); white-space: nowrap;
                    animation: typing 3s steps(40, end), blink-caret 0.75s step-end infinite;
                    animation-fill-mode: forwards; /* Keep final state of typing animation */
                }
                @keyframes typing { from { width: 0; } to { width: 100%; } }
                @keyframes blink-caret { from, to { border-color: transparent; } 50% { border-color: rgba(255,255,255,0.8); } }
                @media (max-width: 480px) {
                    .main-title { font-size: 2.2rem; /* animation: none; border-right: none; */ white-space: normal; /* Allow wrap on very small screens */ }
                    .tibetan-subtitle { font-size: 1.1rem; } .mode-selector-content { padding: 2.5rem 2rem; }
                }
            `;
            document.head.appendChild(dynamicStyle);
        }
    </script>
</body>
</html>