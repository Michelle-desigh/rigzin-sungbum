<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰æ—ºè«¾å¸ƒå…¨é›†é–±è®€ç³»çµ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Tibetan:wght@300;400;500;600;700&family=Noto+Serif+TC:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'Monlam Uni Chouk';
            src: url('fonts/Monlam Uni Chouk.woff2') format('woff2');
            font-weight: normal; font-style: normal; font-display: swap;
        }
        @font-face {
            font-family: 'WenDingCuXingKai';
            src: url('fonts/æ–‡é¼ç²—è¡Œæ¥·.woff2') format('woff2'); /* ç¢ºä¿æª”æ¡ˆåç¨±èˆ‡å¯¦éš›æª”æ¡ˆä¸€è‡´ */
            font-weight: normal; font-style: normal; font-display: swap;
        }
        @font-face {
            font-family: 'Adobe Caslon Pro Italic'; /* å®šç¾©å­—å‹åç¨± */
            src: url('fonts/ACaslonPro-Italic.woff2') format('woff2'); /* ç¢ºä¿æª”æ¡ˆåç¨±èˆ‡å¯¦éš›æª”æ¡ˆä¸€è‡´ */
            font-weight: normal;
            font-style: italic; /* é€šå¸¸ Italic å­—å‹æœ¬èº«å°±æ˜¯æ–œé«”ï¼Œä½†æ˜ç¢ºæŒ‡å®šæœ‰å¥½è™• */
            font-display: swap;
        }
        /* æ‚¨å¯ä»¥ç‚ºæˆªåœ–ä¸­çš„å…¶ä»–è—æ–‡å­—é«”ä¹Ÿæ·»åŠ  @font-face è¦å‰‡ï¼Œå¦‚æœéœ€è¦åœ¨æ­£æ–‡ç­‰å…¶ä»–åœ°æ–¹ä½¿ç”¨å®ƒå€‘ */
        @font-face {
            font-family: 'Jomolhari';
            src: url('fonts/Jomolhari-Regular.woff') format('woff');
            font-weight: normal; font-style: normal; font-display: swap;
        }
        @font-face {
            font-family: 'Monlam Dutsa';
            src: url('fonts/Monlam Dutsa 1 Regular.woff') format('woff'); /* æª”æ¡ˆåç¨±æ³¨æ„ç©ºæ ¼ */
            font-weight: normal; font-style: normal; font-display: swap;
        }
         @font-face {
            font-family: 'Qomolangma Drutsa';
            src: url('fonts/Qomolangma-Drutsa.woff') format('woff');
            font-weight: normal; font-style: normal; font-display: swap;
        }
        /* å¦‚æœæœ‰è¯åº·ä»¿å®‹é«”å’Œè¡Œæ¥·é«”w5ï¼Œä¹Ÿéœ€è¦å®šç¾© */
        @font-face {
            font-family: 'HuaKangFangSongW6'; /* å‡è¨­çš„å­—å‹åç¨± */
            src: url('fonts/è¯åº·ä»¿å®‹é«”W6-B5.woff2') format('woff2');
            font-weight: normal; font-style: normal; font-display: swap;
        }
        @font-face {
            font-family: 'XingKaiTiW5'; /* å‡è¨­çš„å­—å‹åç¨± */
            src: url('fonts/è¡Œæ¥·é«”w5.woff2') format('woff2');
            font-weight: normal; font-style: normal; font-display: swap;
        }


        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            /* ... (é¡è‰²è®Šæ•¸ä¿æŒä¸è®Š) ... */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(20, 20, 30, 0.65);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text-light: rgba(240, 240, 255, 0.95);
            --text-accent: #FFD700;
            --tibetan-title-font: 'Monlam Uni Chouk', 'Noto Sans Tibetan', serif;
            --chinese-title-font: 'WenDingCuXingKai', 'Noto Serif TC', serif;
            --english-subtitle-font: 'Adobe Caslon Pro Italic', 'Inter', serif; /* æ–°å¢è‹±æ–‡å­—é«”è®Šæ•¸ */
            --border-radius-main: 10px;
            --border-radius-small: 5px;
        }

        body { /* ... (body æ¨£å¼ä¿æŒä¸è®Š) ... */ }
        .top-nav { /* ... (top-nav æ¨£å¼ä¿æŒä¸è®Š) ... */ }
        .nav-left, .nav-right { /* ... (æ¨£å¼ä¿æŒä¸è®Š) ... */ }
        .nav-item, .top-nav-btn { /* ... (æ¨£å¼ä¿æŒä¸è®Š) ... */ }

        #modeSelectorScreen { /* ... (æ¨£å¼ä¿æŒä¸è®Š) ... */ }
        .mode-selector-content { /* ... (æ¨£å¼ä¿æŒä¸è®Š) ... */ }

        .main-title { font-family: var(--chinese-title-font); /* æ‡‰ç”¨ä¸­æ–‡å­—é«” */ }
        .tibetan-subtitle { font-family: var(--tibetan-title-font); /* æ‡‰ç”¨è—æ–‡å­—é«” */ }
        .english-subtitle {
            font-family: var(--english-subtitle-font); /* æ‡‰ç”¨è‹±æ–‡å­—é«” */
            font-style: italic; /* å³ä½¿å­—å‹æœ¬èº«æ˜¯ italicï¼Œä¹Ÿæ˜ç¢ºæŒ‡å®š */
            font-size: 1.1rem; color: var(--text-light); margin-bottom: 2rem; opacity: 0.85;
        }
        .mode-buttons { /* ... (æ¨£å¼ä¿æŒä¸è®Š) ... */ }
        .mode-button { /* ... (æ¨£å¼ä¿æŒä¸è®Š) ... */ }

        #appContainer { /* ... (æ¨£å¼ä¿æŒä¸è®Š) ... */ }
        .sidebar { /* ... (æ¨£å¼ä¿æŒä¸è®Š) ... */ }
        .main-content { /* ... (æ¨£å¼ä¿æŒä¸è®Š) ... */ }
        .container { /* ... (æ¨£å¼ä¿æŒä¸è®Š) ... */ }
        .header h1 { font-family: var(--chinese-title-font); }
        .header .tibetan-subtitle-header { font-family: var(--tibetan-title-font); }
        /* ... (å…¶ä»– CSS æ¨£å¼å¤§éƒ¨åˆ†ä¿æŒä¸è®Šï¼Œç¢ºä¿åœ“è§’å’Œå­—å‹è®Šæ•¸å·²æ­£ç¢ºæ‡‰ç”¨) ... */

        /* Footer */
        footer { /* ... (footer æ¨£å¼ä¿æŒä¸è®Š) ... */ }

        /* Dynamic Animation Styles - will be populated by JS */
        #dynamic-animation-styles {}
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="top-nav">
        <div class="nav-left" id="navLeftLinks">
            <!-- JS will populate common links here -->
        </div>
        <div class="nav-right" id="navRightControls">
            <!-- JS will populate mode-specific controls (Login/Tools/Admin actions) -->
        </div>
    </nav>

    <div class="background-container" id="backgroundContainer"></div>

    <div id="modeSelectorScreen">
         <div class="mode-selector-content">
            <h1 class="main-title">æ‰æ—ºè«¾å¸ƒå…¨é›†é–±è®€ç³»çµ±</h1>
            <p class="tibetan-subtitle">à¼„à¼…à¼ à¼à½šà½ºà¼‹à½‘à½–à½„à¼‹à½“à½¼à½¢à¼‹à½–à½´à½ à½²à¼‹à½‚à½¦à½´à½„à¼‹à½ à½–à½´à½˜à¼‹à½€à¾³à½¼à½‚à¼‹à½¦à¾Ÿà½ºà½‚à½¦à¼</p>
            <p class="english-subtitle">Tsewang Norbu Complete Works Reading System</p>
            <div class="mode-buttons">
                <button class="mode-button" onclick="enterMode('read')">ğŸ“– é€²å…¥é–±è®€æ¨¡å¼</button>
                <button class="mode-button" onclick="enterMode('edit')">ğŸ” é€²å…¥ç·¨è¼¯æ¨¡å¼</button>
            </div>
        </div>
    </div>

    <div id="appContainer">
        <!-- ... (App Container å…§éƒ¨çµæ§‹ä¸è®Š) ... -->
    </div>

    <!-- Modals: Document, Admin Login, Article Form, Info Modal -->
    <!-- (Modal HTML structures remain the same) -->

    <div id="messageAreaEl"></div>

    <footer>
        <!-- ... (Footer HTML çµæ§‹ä¸è®Š) ... -->
    </footer>

    <script>
        // --- DATA (Sample) ---
        let documentsData = [];
        const initialDocuments = [ /* æ‚¨å®Œæ•´çš„ JSON æ•¸æ“šæ”¾åœ¨é€™è£¡ */ ];


        // --- DOM Elements (ç¢ºä¿æ‰€æœ‰é¸æ“‡å™¨ä»ç„¶æ­£ç¢º) ---
        const navLeftLinksEl = document.getElementById('navLeftLinks');
        const navRightControlsEl = document.getElementById('navRightControls');
        // (å…¶ä»– DOM å…ƒç´ å®šç¾©...)
        const modeSelectorScreenEl = document.getElementById('modeSelectorScreen');
        const appContainerEl = document.getElementById('appContainer');
        const adminLoginModalEl = document.getElementById('adminLoginModalEl');
        // ... ç¢ºä¿æ‰€æœ‰ç”¨åˆ°çš„ ID éƒ½è¢«ç²å–

        // --- State Variables (ä¿æŒä¸è®Š) ---
        let currentMode = '';
        let isAdminLoggedIn = false;
        // ...

        // --- Mode Management & Top Navigation Controls ---
        function enterMode(mode) {
            console.log("Entering mode:", mode); // èª¿è©¦ä¿¡æ¯
            currentMode = mode;
            modeSelectorScreenEl.style.display = 'none';
            appContainerEl.style.display = 'flex';
            document.body.classList.add('app-active');
            document.body.classList.remove('read-mode', 'edit-mode');
            document.body.classList.add(mode + '-mode');

            updateNavControls(); // æ›´æ–°é ‚éƒ¨å°èˆªæŒ‰éˆ•

            if (mode === 'edit') {
                if (!isAdminLoggedIn) {
                    adminLoginModalEl.classList.add('active');
                } else {
                    setupEditModeUI();
                    loadInitialContentIfNeeded();
                }
            } else { // read mode
                isAdminLoggedIn = false; // ç¢ºä¿é–±è®€æ¨¡å¼ä¸‹éç®¡ç†å“¡
                setupReadModeUI();
                loadInitialContentIfNeeded();
            }
        }

        function showModeSelectorScreen() {
            console.log("Showing mode selector screen"); // èª¿è©¦ä¿¡æ¯
            currentMode = '';
            modeSelectorScreenEl.style.display = 'flex';
            appContainerEl.style.display = 'none';
            document.body.classList.remove('app-active', 'read-mode', 'edit-mode');
            // ç™»å‡ºé‚è¼¯å·²ç§»è‡³ adminLogoutï¼Œé€™è£¡ä¸éœ€è¦è‡ªå‹•ç™»å‡º
            updateNavControls();
        }

        function updateNavControls() {
            console.log("Updating nav controls. Current mode:", currentMode, "isAdminLoggedIn:", isAdminLoggedIn); // èª¿è©¦ä¿¡æ¯
            navLeftLinksEl.innerHTML = '';
            navRightControlsEl.innerHTML = '';

            // å‰µå»ºæŒ‰éˆ•çš„è¼”åŠ©å‡½æ•¸
            function createButton(text, onclickAction, className = 'nav-item') {
                const btn = document.createElement('a'); // ä½¿ç”¨ <a> æ¨™ç±¤æ¨¡ä»¿æŒ‰éˆ•ï¼Œæ–¹ä¾¿ href
                btn.href = "javascript:void(0)";
                btn.className = className;
                btn.textContent = text;
                btn.onclick = onclickAction;
                return btn;
            }

            navLeftLinksEl.appendChild(createButton('å›é¦–é ', showModeSelectorScreen));
            navLeftLinksEl.appendChild(createButton('é—œæ–¼æˆ‘å€‘', () => showInfoModalFromFile('é—œæ–¼æˆ‘å€‘', 'é—œæ–¼æˆ‘å€‘.txt', true)));
            navLeftLinksEl.appendChild(createButton('ç·¨è€…çš„è©±', () => showInfoModalFromFile('ç·¨è€…çš„è©±', 'à½¦à¾’à¾²à½²à½‚à¼‹à½”à¼‹à½”à½¼à½ à½²à¼‹à½‚à½à½˜à¼ç·¨è€…çš„è©±.txt')));
            navLeftLinksEl.appendChild(createButton('åƒè€ƒè³‡æº', () => showInfoModalFromFile('åƒè€ƒè³‡æº', 'åƒè€ƒè³‡æº.txt')));

            if (currentMode === 'edit') {
                if (isAdminLoggedIn) {
                    navRightControlsEl.appendChild(createButton('âœ¨ æ–°å¢', openArticleFormModal, 'top-nav-btn admin-only'));
                    const adminInfoDiv = document.createElement('div');
                    adminInfoDiv.style.cssText = "color:var(--text-light); display:flex; align-items:center; gap:0.3rem; font-size:13px; padding: 0 8px;";
                    adminInfoDiv.className = 'admin-only';
                    adminInfoDiv.innerHTML = `<span>ç®¡ç†å“¡</span><div style="width:18px; height:18px; background:var(--accent-gradient); border-radius:50%; text-align:center; line-height:18px; font-weight:bold; font-size:11px;">A</div>`;
                    navRightControlsEl.appendChild(adminInfoDiv);
                    navRightControlsEl.appendChild(createButton('ç™»å‡º', () => adminLogout(true), 'top-nav-btn admin-only'));
                } else {
                    // ç™»å…¥å½ˆçª—å·²ç”± enterMode('edit') è™•ç†ï¼Œé€™è£¡å¯èƒ½ä¸éœ€è¦é¡å¤–æŒ‰éˆ•
                    // æˆ–è€…å¯ä»¥æ”¾ä¸€å€‹ã€Œå–æ¶ˆç·¨è¼¯æ¨¡å¼ã€æŒ‰éˆ•è¿”å›é¦–é 
                    // navRightControlsEl.appendChild(createButton('å–æ¶ˆ', showModeSelectorScreen, 'top-nav-btn'));
                }
            } else if (currentMode === 'read') {
                navRightControlsEl.appendChild(createButton('ğŸ› ï¸ å·¥å…·', () => toggleSidebar('utilitySidebarEl'), 'top-nav-btn reader-only utility-toggle-btn'));
            } else { // Mode selector screen or initial state (currentMode is '')
                navRightControlsEl.appendChild(createButton('ç™»å…¥', () => enterMode('edit'), 'top-nav-btn'));
            }
        }

        // --- Admin Login/Logout (ä¿æŒä¸è®Šï¼Œä½†ç¢ºä¿ console.log) ---
        adminLoginFormEl.addEventListener('submit', function(e) {
            e.preventDefault();
            // ... (ç™»å…¥é‚è¼¯) ...
            if (username === 'admin' && password === 'password123') {
                isAdminLoggedIn = true; closeModal('adminLoginModalEl');
                showMessage('ç®¡ç†å“¡ç™»å…¥æˆåŠŸï¼', 'success');
                setupEditModeUI();
                updateNavControls(); // ç¢ºä¿å°èˆªæ›´æ–°
                loadInitialContentIfNeeded();
            } else { /* ... */ }
        });
        function adminLogout(switchToReadMode = true) {
            isAdminLoggedIn = false;
            if (switchToReadMode) {
                enterMode('read'); // ç›´æ¥èª¿ç”¨ enterMode('read') ä¾†è™•ç†æ¨¡å¼åˆ‡æ›å’ŒUIæ›´æ–°
                showMessage('ç®¡ç†å“¡å·²ç™»å‡ºã€‚å·²åˆ‡æ›è‡³é–±è®€æ¨¡å¼ã€‚', 'info');
            } else {
                showModeSelectorScreen();
            }
        }

        // --- Load Initial Content (åªåœ¨éœ€è¦æ™‚è¼‰å…¥æ•¸æ“š) ---
        let dataLoaded = false;
        function loadInitialContentIfNeeded() {
            if (!dataLoaded) {
                console.log("Loading initial documents for the first time."); // èª¿è©¦
                loadDocumentsData(); // åŒ…å« processAllDocumentMeta
                renderSidebar();
                renderDocuments();
                dataLoaded = true;
            } else {
                console.log("Documents already loaded, just re-rendering if necessary."); // èª¿è©¦
                //  å¦‚æœéœ€è¦åœ¨æ¨¡å¼åˆ‡æ›æ™‚å¼·åˆ¶é‡ç¹ªï¼Œå¯ä»¥åœ¨é€™è£¡èª¿ç”¨ renderSidebar() å’Œ renderDocuments()
                //  ä½†é€šå¸¸åªæœ‰åœ¨æ•¸æ“šè®ŠåŒ–æ™‚æ‰éœ€è¦é‡ç¹ªåˆ—è¡¨
            }
        }

        // --- å…¶ä»–å‡½æ•¸ (showMessage, updateDocumentMeta, processAllDocumentMeta, loadDocumentsData, renderDocuments, openDocumentModal, updateLanguageSwitcher, showLanguage, closeModal, showInfoModalFromFile, renderSidebar, setActiveSidebarItem, toggleCategory, toggleSidebar, searchInput listener, view mode listeners, toggleFavorite, showFavorites, renderFavoritesList, showUtilityModal, openArticleFormModal, articleFormEl listener) ---
        // é€™äº›å‡½æ•¸çš„å…§éƒ¨é‚è¼¯åŸºæœ¬ä¸è®Šï¼Œä½†è¦ç¢ºä¿å®ƒå€‘èƒ½æ­£ç¢ºå·¥ä½œã€‚

        // --- Initial Call & Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed"); // èª¿è©¦
            showModeSelectorScreen(); // ç¢ºä¿é€™æ˜¯ç¬¬ä¸€å€‹èª¿ç”¨çš„ UI ç‹€æ…‹å‡½æ•¸
            // updateNavControls(); // showModeSelectorScreen å…§éƒ¨æœƒèª¿ç”¨å®ƒ

            // ... (å…¶ä»– DOMContentLoaded å…§çš„é‚è¼¯ï¼Œå¦‚å‹•ç•«æ¨£å¼æ³¨å…¥) ...
            const mainTitleAnimEl = document.querySelector('.main-title');
            if (mainTitleAnimEl) {
                mainTitleAnimEl.addEventListener('animationend', function(event) {
                    if (event.animationName === 'typing') {
                        mainTitleAnimEl.style.borderRight = 'none';
                        mainTitleAnimEl.style.width = 'auto';
                    }
                });
            }
        });

        // (å…¶ä»–å…¨å±€äº‹ä»¶ç›£è½å™¨ï¼Œå¦‚ keydown)
    </script>
</body>
</html>